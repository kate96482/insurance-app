<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <meta name="apple-mobile-web-app-title" content="小邦手">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MBTI 性格測驗 - 小邦手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #A29BFE;
            --secondary: #6C5CE7;
            --bg: #F8F9FA;
            --accent: #FF7675;
        }
        body { 
            font-family: "Microsoft JhengHei", sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 15px; 
            display: flex; flex-direction: column; align-items: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mbti-container { width: 100%; max-width: 500px; background: white; border-radius: 25px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); box-sizing: border-box; }
        
        /* 進度條樣式 */
        .progress-box { width: 100%; height: 6px; background: #eee; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }
        
        /* 選項按鈕樣式 */
        .options-container { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .opt-btn { 
            border: none; padding: 14px; border-radius: 50px; font-weight: bold; 
            cursor: pointer; transition: 0.2s; font-size: 0.95rem; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .opt-btn:active { transform: scale(0.96); opacity: 0.8; }
        
        .opt-agree-3 { background-color: #D1E9FF; color: #0056b3; }
        .opt-neutral { background-color: #F1F3F5; color: #888; }
        .opt-disagree-3 { background-color: #FFCAD4; color: #c9184a; }

        /* 直接跳轉 - 16宮格選擇 */
        .mbti-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
        .grid-item { 
            background: #f0eeff; border: 1px solid var(--primary); border-radius: 10px; padding: 10px 0;
            text-align: center; font-weight: bold; font-size: 0.8rem; color: var(--secondary); cursor: pointer;
        }
        .grid-item:active { background: var(--primary); color: white; }

        /* 結果與分析 */
        #capture-area { 
            background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%);
            padding: 40px 20px; text-align: center; border-radius: 20px; 
            position: relative; overflow: hidden;
        }
        .result-card-design { 
            background: rgba(255,255,255,0.9); padding: 30px 20px; 
            border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border: 1px solid white;
        }
        #res-code { font-size: 3.5rem; color: var(--secondary); margin: 10px 0; letter-spacing: 2px; }
        #res-name { color: #333; margin-bottom: 20px; font-size: 1.5rem; }
        
        /* 深度分析樣板區塊 */
        .analysis-box { margin-top: 25px; text-align: left; background: #fff; padding: 15px; border-radius: 15px; border-left: 5px solid var(--secondary); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .analysis-title { font-weight: bold; color: var(--secondary); margin-bottom: 8px; font-size: 0.95rem; }
        .analysis-text { font-size: 0.85rem; color: #555; line-height: 1.6; }

        #final-image-wrapper img { width: 100%; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); margin-top: 10px; }
        
        .btn { padding: 12px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-link { background: none; color: var(--secondary); text-decoration: underline; font-size: 0.9rem; margin-top: 10px;}
        .btn-secondary { background: #eee; color: #666; }
    </style>
</head>
<body>

<div id="mbti-app" class="mbti-container">
    <div id="quiz-intro" class="quiz-step">
        <div style="text-align: center; margin-bottom: 20px;">
            <i class="fa-solid fa-compass-drafting" style="font-size: 4rem; color: var(--primary); margin-bottom: 15px;"></i>
            <h2 style="color:var(--secondary);">MBTI 性格傾向測驗</h2>
            <p style="color: #666; line-height: 1.6;">探索你的內在核心，發現你的靈魂色彩。</p>
        </div>
        <div style="text-align: center; display: flex; flex-direction: column; gap: 10px; align-items: center;">
            <button class="btn btn-primary" style="width: 80%;" onclick="startQuiz()">開始深度測驗</button>
            <button class="btn btn-link" onclick="toggleQuickSelect()">我已經測過了，直接分析</button>
            <button class="btn btn-secondary" style="width: 80%; margin-top: 15px;" onclick="goHome()">返回首頁</button>
        </div>

        <div id="quick-select" style="display: none; border-top: 1px solid #eee; margin-top: 20px;">
            <p style="font-size: 0.8rem; color: #888; text-align: center; margin-top: 15px;">請選擇您的人格代碼：</p>
            <div class="mbti-grid" id="mbti-grid-btns"></div>
        </div>
    </div>

    <div id="quiz-content" class="quiz-step" style="display:none;">
        <div class="quiz-top">
            <div class="progress-box"><div id="progress-bar"></div></div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; margin-bottom: 20px;">
                <span onclick="confirmExit()" style="cursor:pointer;"><i class="fa-solid fa-xmark"></i> 放棄</span>
                <span id="progress-text">0 / 60</span>
            </div>
        </div>
        <div style="min-height: 80px; display: flex; align-items: center; justify-content: center;">
            <h3 id="q-text" style="text-align: center; margin: 0; color: #333; line-height: 1.4;">題目載入中...</h3>
        </div>
        <div class="options-container">
            <button class="opt-btn opt-agree-3" onclick="handleAnswer(3)">非常同意</button>
            <button class="opt-btn opt-neutral" onclick="handleAnswer(0)">中立</button>
            <button class="opt-btn opt-disagree-3" onclick="handleAnswer(-3)">非常不同意</button>
        </div>
        </div>

    <div id="result-page" class="quiz-step" style="display:none;">
        <div id="capture-area">
            <div class="result-card-design">
                <div style="color:var(--secondary); font-weight:bold; font-size:0.8rem; margin-bottom:5px;">MBTI 鑑定報告</div>
                <h1 id="res-code">----</h1>
                <h2 id="res-name">人格稱號</h2>
                <div id="res-desc"></div>
                <div class="celebs-tag" style="background: var(--secondary); color: white; padding: 12px; border-radius: 12px; margin-top: 20px; font-size: 0.85rem;">
                    <div style="font-weight:bold; margin-bottom:5px; opacity:0.8;">代表人物</div>
                    <span id="res-celebs"></span>
                </div>
            </div>
        </div>
        
        <div id="final-image-wrapper"></div>

        <div id="deep-analysis-section">
            <div class="analysis-box">
                <div class="analysis-title"><i class="fa-solid fa-star"></i> 性格優勢</div>
                <div id="res-strength" class="analysis-text"></div>
            </div>
            <div class="analysis-box">
                <div class="analysis-title"><i class="fa-solid fa-circle-exclamation"></i> 潛在挑戰</div>
                <div id="res-weakness" class="analysis-text"></div>
            </div>
            <div class="analysis-box">
                <div class="analysis-title"><i class="fa-solid fa-heart"></i> 伴侶與社交</div>
                <div id="res-social" class="analysis-text"></div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="location.reload()">重新測驗</button>
            <button class="btn btn-primary" onclick="goHome()">回首頁</button>
        </div>
    </div>
</div>

<script>
// (題目部分保持原樣)
const mbtiQuestions = [ /* ... 你的60題代碼 ... */ ];

// 擴展數據庫庫：新增深度分析內容
const personalityData = {
    "INTJ": { 
        name: "建築師", 
        desc: "你擁有強大的意志與獨立思考能力，追求效率，是天生的戰略家。", 
        celebs: "埃隆·馬斯克、尼采",
        strength: "理性冷靜、遠見卓識、獨立自主、執行力強。",
        weakness: "過於毒舌、忽視情感、對人苛刻、不善社交。",
        social: "傾向與聰明的人交往，在感情中非常理性，需要獨立空間。"
    },
    "INFP": { 
        name: "調解者", 
        desc: "溫柔富有同理心的夢想家，堅守內在價值，尋找生活意義。", 
        celebs: "莎士比亞、JK羅琳",
        strength: "極具同理心、想像力豐富、價值觀堅定、包容力高。",
        weakness: "過於理想化、逃避衝突、容易自我質疑、細節執行弱。",
        social: "尋求靈魂伴侶，情感細膩深沉，害怕被誤解，需要被肯定。"
    },
    // ... 其他人格請依此格式補完
};

// 為了示範，若沒定義的顯示通用內容
function getDeepData(code) {
    const baseCode = code.split('-')[0];
    return personalityData[baseCode] || { 
        name: "探索者", desc: "您是一個充滿可能性的人。", celebs: "尚未登錄",
        strength: "具備該類型特有的天賦潛能。", weakness: "需要注意平衡內在壓力。", social: "在互動中尋求理解與成長。"
    };
}

// 切換快速選擇區
function toggleQuickSelect() {
    const div = document.getElementById('quick-select');
    div.style.display = div.style.display === 'none' ? 'block' : 'none';
    
    if(div.style.display === 'block') {
        const grid = document.getElementById('mbti-grid-btns');
        const types = Object.keys(personalityData);
        // 如果你的資料庫還沒寫滿，先手動定義16種
        const allTypes = ['INTJ','INTP','ENTJ','ENTP','INFJ','INFP','ENFJ','ENFP','ISTJ','ISFJ','ESTJ','ESFJ','ISTP','ISFP','ESTP','ESFP'];
        grid.innerHTML = allTypes.map(t => `<div class="grid-item" onclick="showResultPage('${t}')">${t}</div>`).join('');
        div.scrollIntoView({ behavior: 'smooth' });
    }
}

// 修改後的核心結果顯示
function showResultPage(code) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    document.getElementById('quiz-intro').style.display = 'none';
    document.getElementById('quiz-content').style.display = 'none';
    document.getElementById('result-page').style.display = 'block';
    
    const data = getDeepData(code);

    // 填入基本資料
    document.getElementById('res-code').innerText = code.includes('-') ? code : `${code}-A`;
    document.getElementById('res-name').innerText = data.name;
    document.getElementById('res-desc').innerHTML = `<p>${data.desc}</p>`;
    document.getElementById('res-celebs').innerText = data.celebs;

    // 填入深度分析
    document.getElementById('res-strength').innerText = data.strength;
    document.getElementById('res-weakness').innerText = data.weakness;
    document.getElementById('res-social').innerText = data.social;

    // 生成圖卡
    const captureArea = document.getElementById('capture-area');
    const wrapper = document.getElementById('final-image-wrapper');
    wrapper.innerHTML = '<div style="text-align: center; padding: 20px; color: #aaa;"><i class="fa-solid fa-circle-notch fa-spin"></i> 正在生成名片...</div>';

    setTimeout(() => {
        html2canvas(captureArea, { scale: 2, useCORS: true }).then(canvas => {
            const img = document.createElement('img');
            img.src = canvas.toDataURL("image/png");
            wrapper.innerHTML = "";
            wrapper.appendChild(img);
            captureArea.style.display = "none";
        });
    }, 1000);
}

// ...其餘 startQuiz, handleAnswer, goHome 等 Function 保持不變 ...
</script>
</body>
</html>
