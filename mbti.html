<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MBTI é€²éšè¨ºæ–· - å°é‚¦æ‰‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary: #A29BFE; --secondary: #6C5CE7; --bg: #F8F9FA; --accent: #FF9F43; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; -webkit-tap-highlight-color: transparent; }
        .mbti-container { width: 100%; max-width: 500px; background: white; border-radius: 25px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); box-sizing: border-box; position: relative; }
        
        /* å°èˆªèˆ‡é€²åº¦ */
        .quiz-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; height: 30px; }
        .nav-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 0.9rem; padding: 5px; transition: 0.2s; }
        .progress-box { width: 100%; height: 6px; background: #eee; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: 0.4s; }
        
        /* é¸é … */
        .options-container { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; }
        .opt-btn { border: none; padding: 16px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .opt-agree-3 { background-color: #D1E9FF; color: #0056b3; }
        .opt-neutral { background-color: #F1F3F5; color: #888; }
        .opt-disagree-3 { background-color: #FFCAD4; color: #c9184a; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        .input-group { margin: 20px 0; text-align: left; }
        .name-input { width: 100%; padding: 14px; border-radius: 15px; border: 2px solid #eee; box-sizing: border-box; font-size: 1rem; }
        .type-selector { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 20px; }
        .btn { padding: 12px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-outline { background: white; color: var(--secondary); border: 2px solid var(--secondary); }

        /* çµæœå±•ç¤º */
        .result-header { background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; padding: 30px 15px; border-radius: 20px; margin-bottom: 20px; }
        .analysis-section { text-align: left; margin-bottom: 15px; background: #fdfdfd; border-radius: 15px; padding: 15px; border-left: 5px solid var(--primary); }

        /* å½ˆçª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 100%; max-width: 320px; text-align: center; }
/* äººæ ¼å¤§é¡é…è‰² */
.theme-nt { background: linear-gradient(135deg, #6c5ce7, #a29bfe) !important; } /* åˆ†æå¸«-ç´« */
.theme-nf { background: linear-gradient(135deg, #00b894, #55efc4) !important; } /* å¤–äº¤å®˜-ç¶  */
.theme-sj { background: linear-gradient(135deg, #0984e3, #74b9ff) !important; } /* å®ˆè­·è€…-è— */
.theme-sp { background: linear-gradient(135deg, #e17055, #fab1a0) !important; } /* æ¢éšªå®¶-æ©˜ */

/* æç¤ºæ–‡å­—æ¨£å¼ */
.save-hint { 
    text-align: center; 
    color: #888; 
    font-size: 0.85rem; 
    margin: 15px 0; 
    animation: pulse 2s infinite; 
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}
    </style>
</head>
<body>

<div id="mbti-app" class="mbti-container">
   <div id="quiz-intro" class="quiz-step">
    <div style="text-align: center; margin-bottom: 20px;">
        <i class="fa-solid fa-dna" style="font-size: 3.5rem; color: var(--primary); margin-bottom: 10px;"></i>
        <h2 style="color:var(--secondary); margin-bottom: 5px;">MBTI æ€§æ ¼å‚¾å‘æ¸¬é©—</h2>
        
        <p style="color: #666; font-size: 0.95rem; margin: 10px 0 5px 0;">æ¢ç´¢ä½ çš„å…§åœ¨æ ¸å¿ƒï¼Œç™¼ç¾ä½ çš„éˆé­‚è‰²å½©ã€‚</p>
        <p style="color: #999; font-size: 0.85rem; margin-bottom: 15px;">è«‹æ ¹æ“šç¬¬ä¸€ç›´è¦ºä½œç­”ã€‚</p>
        
        <div style="display: inline-block; background: #f0f0ff; padding: 5px 15px; border-radius: 10px; color: var(--secondary); font-size: 0.85rem; font-weight: bold;">
            åŸºæœ¬åˆ†æ ğŸ“ 60 é¡Œ | â± é è¨ˆ 5-8 åˆ†é˜
        </div>
        </div>
    
    <div class="input-group">
        <label style="font-size: 0.8rem; color: #888;">è«‹è¼¸å…¥æ¸¬é©—è€…å§“åï¼š</label>
        <input type="text" id="user-name-input" class="name-input" placeholder="æ‚¨çš„æš±ç¨±">
    </div>
        <button class="btn btn-primary" onclick="startFlow('new')">å°šæœªæ¸¬é©—ï¼Œé–‹å§‹ 60 é¡Œ</button>
        <div style="margin: 20px 0; text-align: center; color: #bbb; font-size: 0.8rem;">â€”â€” æˆ–è€… â€”â€”</div>
        <select id="known-type" class="type-selector">
            <option value="INTJ">INTJ å»ºç¯‰å¸«</option><option value="INTP">INTP é‚è¼¯å­¸å®¶</option>
            <option value="ENTJ">ENTJ æŒ‡æ®å®˜</option><option value="ENTP">ENTP è¾¯è«–å®¶</option>
            <option value="INFJ">INFJ æå€¡è€…</option><option value="INFP">INFP èª¿è§£è€…</option>
            <option value="ENFJ">ENFJ ä¸»äººå…¬</option><option value="ENFP">ENFP ç«¶é¸è€…</option>
            <option value="ISTJ">ISTJ ç‰©æµå¸«</option><option value="ISFJ">ISFJ å®ˆè­·è€…</option>
            <option value="ESTJ">ESTJ ç¸½ç®¡</option><option value="ESFJ">ESFJ åŸ·æ”¿å®˜</option>
            <option value="ISTP">ISTP é‘‘è³å®¶</option><option value="ISFP">ISFP è—è¡“å®¶</option>
            <option value="ESTP">ESTP ä¼æ¥­å®¶</option><option value="ESFP">ESFP è¡¨æ¼”è€…</option>
        </select>
        <button class="btn btn-outline" onclick="startFlow('direct')">å·²çŸ¥å‹è™Ÿï¼Œåš 20 é¡Œé€²éšé¡Œ</button>
    </div>

    <div id="quiz-content" class="quiz-step" style="display:none;">
        <div class="quiz-nav">
    <button class="nav-btn" id="prev-btn" onclick="goBack()">
        <i class="fa-solid fa-chevron-left"></i> ä¸Šä¸€é¡Œ
    </button>
    <button class="nav-btn" onclick="toggleReturnModal(true)">
        è¿”å› <i class="fa-solid fa-arrow-rotate-left"></i>
    </button>
</div>
        <div class="progress-box"><div id="progress-bar"></div></div>
        <div style="text-align: center; min-height: 80px; display: flex; align-items: center; justify-content: center;">
            <h3 id="q-text" style="margin: 0; color: #333;"></h3>
        </div>
        <div class="options-container">
            <button class="opt-btn opt-agree-3" onclick="handleAnswer(3)">éå¸¸ç¬¦åˆ</button>
            <button class="opt-btn opt-neutral" onclick="handleAnswer(0)">ä¸­ç«‹ / è¦–æƒ…æ³</button>
            <button class="opt-btn opt-disagree-3" onclick="handleAnswer(-3)">å®Œå…¨ä¸ç¬¦</button>
        </div>
    </div>

    <div id="result-page" class="quiz-step" style="display:none;">
        <div id="capture-area">
            <div class="result-header" style="text-align:center;">
                <div id="res-user-name" style="background:rgba(255,255,255,0.2); display:inline-block; padding:2px 12px; border-radius:20px; font-size:0.9rem;"></div>
                <h1 id="res-full-code" style="margin:10px 0 0 0;"></h1>
                <h2 id="res-title" style="margin:5px 0;"></h2>
            </div>
            <div id="analysis-body">
                </div>
        </div>
        <div id="final-image-wrapper"></div>
        <div id="result-actions">
             <button class="btn btn-primary" onclick="location.reload()">é‡æ–°æ¸¬é©—</button>
        </div>
    </div>
</div>

<div id="advance-confirm-modal" class="modal-overlay">
    <div class="modal-content">
        <i class="fa-solid fa-circle-check" style="font-size: 3rem; color: #4CD137; margin-bottom: 15px;"></i>
        <h3>ä¸»äººæ ¼æ¸¬é©—å®Œæˆï¼</h3>
        <p style="color: #666; font-size: 0.9rem;">æ‚¨çš„çµæœå·²ç”Ÿæˆã€‚æƒ³é€²ä¸€æ­¥è§£é–ã€Œæœæ–·åº¦ã€èˆ‡ã€Œæº«æš–åº¦ã€çš„ 64 ç¨®äºå‹æ·±åº¦å ±å‘Šå—ï¼Ÿ</p>
        <button class="btn btn-primary" onclick="continueToAdvance()">æŒ‘æˆ° 20 é¡Œé€²éšåˆ†æ</button>
        <button class="btn btn-outline" onclick="closeModalAndShowBase()">ä¸ç”¨äº†ï¼Œçœ‹åŸºç¤å ±å‘Š</button>
    </div>
</div>
<div id="return-modal" class="modal-overlay">
    <div class="modal-content">
        <i class="fa-solid fa-circle-exclamation" style="font-size: 3rem; color: var(--accent); margin-bottom: 15px;"></i>
        <h3>ç¢ºå®šè¦ä¸­æ–·å—ï¼Ÿ</h3>
        <p style="color: #666; font-size: 0.9rem;">ç¾åœ¨é›¢é–‹å°‡ä¸æœƒä¿ç•™æ¸¬é©—é€²åº¦å”·ï¼</p>
        <button class="btn btn-primary" onclick="location.reload()">é‡æ–°æ¸¬é©— / è¿”å›</button>
        <button class="btn btn-outline" onclick="toggleReturnModal(false)">ç¹¼çºŒæ¸¬é©—</button>
    </div>
</div>

<script>
// é¡Œç›®æ•¸æ“š (ç°¡åŒ–ç¤ºæ„)
const mbtiBaseQuestions = [
    { text: "1.åœ¨ç¤¾äº¤èšæœƒä¸­ï¼Œä½ é€šå¸¸æ˜¯ä¸»å‹•æ‰¾äººäº¤è«‡çš„é‚£ä¸€ä½ã€‚", dim: "EI", dir: 1 },
    { text: "2.ä½ å‚¾å‘æ–¼æ ¹æ“šäº‹å¯¦å’Œè­‰æ“šåšæ±ºå®šï¼Œè€Œéæ†‘æ„Ÿè¦ºã€‚", dim: "TF", dir: 1 },
    { text: "3.ä½ å–œæ­¡äº‹å…ˆè¦åŠƒå¥½æ—…éŠè¡Œç¨‹ï¼Œè€Œéåˆ°äº†ç•¶åœ°å†æ±ºå®šã€‚", dim: "JP", dir: 1 },
    { text: "4.ä½ å¸¸èŠ±æ™‚é–“æ€è€ƒå®‡å®™çš„å¥§ç§˜æˆ–äººé¡çš„æœªä¾†ã€‚", dim: "SN", dir: -1 },
    { text: "5.ç•¶åˆ¥äººåœ¨ä½ é¢å‰å“­æ³£æ™‚ï¼Œä½ ç¬¬ä¸€åæ‡‰æ˜¯æƒ³å®‰æ…°ä»–è€Œéåˆ†æåŸå› ã€‚", dim: "TF", dir: -1 },
    { text: "6.ä½ è¦ºå¾—åœ¨è¾¦å…¬æ¡Œå‰äº•ç„¶æœ‰åºåœ°å·¥ä½œæ¯”éš¨æ€§ç™¼æ®æ›´æœ‰æ•ˆç‡ã€‚", dim: "JP", dir: 1 },
    { text: "7.ä½ å–œæ­¡æˆç‚ºçœ¾äººçŸšç›®çš„ç„¦é»ã€‚", dim: "EI", dir: 1 },
    { text: "8.ä½ æ¯”è¼ƒçœ‹é‡äº‹ç‰©çš„å¯¦éš›æ‡‰ç”¨åƒ¹å€¼ï¼Œè€Œéç†è«–ç¾æ„Ÿã€‚", dim: "SN", dir: 1 },
    { text: "9.ä½ å¾ˆå°‘åœ¨æ²’æœ‰å‚™æ¡ˆçš„æƒ…æ³ä¸‹è¡Œå‹•ã€‚", dim: "JP", dir: 1 },
    { text: "10.ä½ å®¹æ˜“ç†è§£ä»–äººçš„æƒ…ç·’æ³¢å‹•ã€‚", dim: "TF", dir: -1 },
    { text: "11.åœ¨èšæœƒå¾Œï¼Œä½ æ„Ÿåˆ°å……æ»¿æ´»åŠ›è€Œéç²¾ç–²åŠ›ç«­ã€‚", dim: "EI", dir: 1 },
    { text: "12.ä½ æ›´å–œæ­¡å˜—è©¦æ–°çš„æ–¹æ³•ï¼Œè€Œéæ²¿ç”¨èˆŠæœ‰çš„ç¿’æ…£ã€‚", dim: "SN", dir: -1 },
    { text: "13.ä½ é€šå¸¸æœƒå…ˆå®Œæˆå·¥ä½œå†ç©æ¨‚ã€‚", dim: "JP", dir: 1 },
    { text: "14.ä½ èªç‚ºé‚è¼¯æ¯”æƒ…æ„Ÿæ›´èƒ½ä»£è¡¨ä¸€å€‹äººçš„æ™ºæ…§ã€‚", dim: "TF", dir: 1 },
    { text: "15.ä½ å‚¾å‘æ–¼ç¨è‡ªæ€è€ƒå•é¡Œï¼Œè€Œéèˆ‡ä»–äººè¨è«–ã€‚", dim: "EI", dir: -1 },
    { text: "16.ä½ å®¹æ˜“è¢«æŠ½è±¡è—è¡“æˆ–è©©æ­Œæ‰€æ„Ÿå‹•ã€‚", dim: "SN", dir: -1 },
    { text: "17.ä½ å–œæ­¡ç”Ÿæ´»å……æ»¿é©šå–œèˆ‡ä¸å¯é æ¸¬æ€§ã€‚", dim: "JP", dir: -1 },
    { text: "18.ä½ å¾ˆé›£æ‹’çµ•ä»–äººçš„è«‹æ±‚ï¼Œå³ä½¿é€™æœƒè®“ä½ å¾ˆç´¯ã€‚", dim: "TF", dir: -1 },
    { text: "19.ä½ è¦ºå¾—å¤§è‡ªç„¶èˆ‡å¯§éœæ¯”ç†±é¬§çš„è¡—é“æ›´æœ‰å¸å¼•åŠ›ã€‚", dim: "EI", dir: -1 },
    { text: "20.ä½ å°å…·é«”çš„ç´°ç¯€è§€å¯Ÿå…¥å¾®ï¼Œä¾‹å¦‚æœ‹å‹ä»Šå¤©æ›äº†è€³ç’°ã€‚", dim: "SN", dir: 1 },
    { text: "21.ä½ ç¸½èƒ½æº–æ™‚èµ´ç´„ï¼Œç”šè‡³ææ—©åˆ°é”ã€‚", dim: "JP", dir: 1 },
    { text: "22.åœ¨è¡çªä¸­ï¼Œä½ æ›´åœ¨æ„èª°å°èª°éŒ¯è€Œéèª°å—å‚·äº†ã€‚", dim: "TF", dir: 1 },
    { text: "23.ä½ å–œæ­¡é€éç¤¾äº¤åª’é«”åˆ†äº«ä½ çš„ç”Ÿæ´»é»æ»´ã€‚", dim: "EI", dir: 1 },
    { text: "24.ä½ å–œæ­¡æƒ³åƒå„ç¨®å¯èƒ½ç™¼ç”Ÿçš„ã€å¦‚æœ...æ€éº¼è¾¦ã€æƒ…å¢ƒã€‚", dim: "SN", dir: -1 },
    { text: "25.ä½ çš„æƒ…ç·’é€šå¸¸å¾ˆç©©å®šï¼Œä¸å®¹æ˜“å—å¤–ç•Œå½±éŸ¿ã€‚", dim: "TF", dir: 1 },
    { text: "26.ä½ å–œæ­¡åœ¨å£“åŠ›ä¸‹å·¥ä½œï¼Œé€™è®“ä½ æ›´æœ‰å‹•åŠ›ã€‚", dim: "JP", dir: -1 },
    { text: "27.ä½ æ˜¯ä¸€å€‹æ¯”è¼ƒå®‰éœã€è©±ä¸å¤šçš„äººã€‚", dim: "EI", dir: -1 },
    { text: "28.ä½ èªç‚ºå‚³çµ±å’Œè¦å‰‡æ˜¯æœ‰å…¶å¿…è¦æ€§çš„ã€‚", dim: "SN", dir: 1 },
    { text: "29.ä½ å¸¸å¸¸åœ¨æœ€å¾Œä¸€åˆ»æ‰é–‹å§‹åšæº–å‚™ã€‚", dim: "JP", dir: -1 },
    { text: "30.ä½ å–œæ­¡å¹«åŠ©åˆ¥äººè§£æ±ºæƒ…æ„Ÿä¸Šçš„å›°æ“¾ã€‚", dim: "TF", dir: -1 },
    { text: "31.ä½ äº«å—ç¨è™•çš„æ™‚å…‰ï¼Œé‚£æ˜¯ä½ å……é›»çš„æ–¹å¼ã€‚", dim: "EI", dir: -1 },
    { text: "32.ä½ æ›´å–œæ­¡é–±è®€å¯¦ç”¨æ€§çš„æ›¸ç±è€Œéç§‘å¹»å°èªªã€‚", dim: "SN", dir: 1 },
    { text: "33.ä½ å–œæ­¡ç¶­æŒç’°å¢ƒçš„æ•´æ½”ï¼Œé€™è®“ä½ æ„Ÿåˆ°å¿ƒéˆå¹³éœã€‚", dim: "JP", dir: 1 },
    { text: "34.ä½ èªªè©±éå¸¸ç›´æ¥ï¼Œç”šè‡³æœ‰æ™‚æœƒè¢«èªç‚ºå†·é…·ã€‚", dim: "TF", dir: 1 },
    { text: "35.ä½ åœ¨é›»è©±æ¥è½å‰ï¼ŒæœƒçŒ¶è±«ä¸€ä¸‹è¦èªªä»€éº¼ã€‚", dim: "EI", dir: -1 },
    { text: "36.ä½ å¸¸å¸¸æœ‰éˆå…‰ä¸€é–ƒçš„ç›´è¦ºï¼Œä¸”é€šå¸¸å¾ˆæº–ã€‚", dim: "SN", dir: -1 },
    { text: "37.ä½ è¦ºå¾—è¦å‰‡æ˜¯æ­»çš„äººæ˜¯æ´»çš„ï¼Œæ‡‰è©²éˆæ´»è®Šé€šã€‚", dim: "JP", dir: -1 },
    { text: "38.ä½ å¾ˆå®¹æ˜“å°èº«è™•å›°å¢ƒçš„äººç”¢ç”ŸåŒç†å¿ƒã€‚", dim: "TF", dir: -1 },
    { text: "39.ä½ å–œæ­¡åƒåŠ å¤§å‹æ´»å‹•ï¼Œå¦‚æ¼”å”±æœƒæˆ–å¸‚é›†ã€‚", dim: "EI", dir: 1 },
    { text: "40.ä½ å¾ˆåœ¨æ„è³‡æ–™çš„æº–ç¢ºæ€§ï¼Œæœƒåè¦†ç¢ºèªæ•¸å­—ã€‚", dim: "SN", dir: 1 },
    { text: "41.ä½ å–œæ­¡æŠŠæœªä¾†çš„è¨ˆåŠƒå¯«åœ¨è¡Œäº‹æ›†ä¸Šã€‚", dim: "JP", dir: 1 },
    { text: "42.ä½ èªç‚ºå…¬å¹³æ­£ç¾©æ¯”æ…ˆæ‚²æ†æ†«æ›´é‡è¦ã€‚", dim: "TF", dir: 1 },
    { text: "43.ä½ å¾ˆå°‘ä¸»å‹•åœ¨æœƒè­°æˆ–ç¾¤çµ„ä¸­ç‡å…ˆç™¼è¡¨æ„è¦‹ã€‚", dim: "EI", dir: -1 },
    { text: "44.ä½ æ›´å–œæ­¡æ€è€ƒäº‹ç‰©çš„æœ¬è³ªï¼Œè€Œéå…¶å¤–è¡¨ã€‚", dim: "SN", dir: -1 },
    { text: "45.ä½ å¸¸å¸¸éš¨æ€§æ‰€è‡³åœ°æ”¹è®Šç•¶å¤©çš„è¨ˆç•«ã€‚", dim: "JP", dir: -1 },
    { text: "46.ä½ å¾ˆæ“…é•·åˆ†æåˆ¥äººçš„è¡Œç‚ºå‹•æ©Ÿã€‚", dim: "TF", dir: 1 },
    { text: "47.ä½ å–œæ­¡å’Œä¸€ç¾¤æœ‹å‹å¾…åœ¨ä¸€èµ·æ›´å‹æ–¼å–®ç¨ç´„æœƒã€‚", dim: "EI", dir: 1 },
    { text: "48.ä½ æ¯”è¼ƒå¯¦éš›ï¼Œä¸æœƒæ²‰æººæ–¼ç™½æ—¥å¤¢ã€‚", dim: "SN", dir: 1 },
    { text: "49.ä½ å°é›œäº‚çš„ç’°å¢ƒè€å—åº¦å¾ˆé«˜ã€‚", dim: "JP", dir: -1 },
    { text: "50.ä½ æœƒç‚ºäº†ä¸å‚·å®³åˆ¥äººçš„æ„Ÿæƒ…è€Œèªªå–„æ„çš„è¬Šè¨€ã€‚", dim: "TF", dir: -1 },
    { text: "51.ä½ æ˜¯ç¤¾äº¤å ´åˆä¸­çš„æ°£æ°›å¸¶å‹•è€…ã€‚", dim: "EI", dir: 1 },
    { text: "52.ä½ å°æ–°å¥‡çš„ç”¢å“å’Œç§‘æŠ€å……æ»¿å¼·çƒˆå¥½å¥‡å¿ƒã€‚", dim: "SN", dir: -1 },
    { text: "53.ä½ å–œæ­¡äº‹æƒ…æœ‰æ˜ç¢ºçš„é–‹å§‹èˆ‡çµæŸæ—¥æœŸã€‚", dim: "JP", dir: 1 },
    { text: "54.ä½ æ±ºç­–æ™‚åå‘å®¢è§€åˆ†æï¼Œè€Œéå€‹äººä¸»è§€å–œå¥½ã€‚", dim: "TF", dir: 1 },
    { text: "55.ä½ åœ¨é™Œç”Ÿäººé¢å‰æœƒè¡¨ç¾å¾—æ¯”è¼ƒæ‹˜è¬¹ã€‚", dim: "EI", dir: -1 },
    { text: "56.ä½ å°æ­·å²éºè·¡å’Œéå»ç™¼ç”Ÿçš„äº‹å¾ˆæ„Ÿèˆˆè¶£ã€‚", dim: "SN", dir: 1 },
    { text: "57.ä½ è¦ºå¾—æŒ‰ç…§æ­¥é©Ÿæ¸…å–®æ“ä½œæ¯”æ‘¸ç´¢æ›´æœ‰å®‰å…¨æ„Ÿã€‚", dim: "JP", dir: 1 },
    { text: "58.ä½ æœƒæ ¹æ“šç•¶ä¸‹çš„æƒ…ç·’ä¾†åšæ±ºå®šã€‚", dim: "TF", dir: -1 },
    { text: "59.å³ä½¿åœ¨ç†±é¬§çš„åœ°æ–¹ï¼Œä½ ä¹Ÿå¯èƒ½æ„Ÿåˆ°å­¤ç¨ã€‚", dim: "EI", dir: -1 },
    { text: "60.ä½ å–œæ­¡è¿½æ±‚å…·æœ‰è±¡å¾µæ„ç¾©çš„æ±è¥¿ã€‚", dim: "SN", dir: -1 }
];
const advanceQuestions = [
    { text: "1.åœ¨é¤å»³é»é¤æ™‚ï¼Œä½ é€šå¸¸èƒ½åœ¨ 1 åˆ†é˜å…§æ±ºå®šå¥½è¦åƒä»€éº¼ã€‚", dim: "AO", dir: 1 },
    { text: "2.ç¶²è³¼çœ‹åˆ°å¿ƒå„€å•†å“æ™‚ï¼Œä½ å‚¾å‘è¿…é€Ÿä¸‹å–®è€Œéåè¦†å°æ¯”è©•è«–ã€‚", dim: "AO", dir: 1 },
    { text: "3.é¢å°è¨ˆåŠƒå¤–çš„è¡Œç¨‹è®Šå‹•ï¼Œä½ é€šå¸¸èƒ½å¿«é€Ÿèª¿æ•´å¿ƒæ…‹é‚Šèµ°é‚Šçœ‹ã€‚", dim: "AO", dir: 1 },
    { text: "4.åšå®Œé‡å¤§æ±ºå®šå¾Œï¼Œä½ å¾ˆå°‘æœƒå»æƒ³ã€Œç•¶åˆé¸å¦ä¸€å€‹æœƒä¸æœƒæ›´å¥½ã€ã€‚", dim: "AO", dir: 1 },
    { text: "5.è™•ç†è¨Šæ¯æˆ–éƒµä»¶æ™‚ï¼Œä½ åå¥½å¿«é€Ÿå›è¦†é‡é»è€Œéæ–Ÿé…Œæ–‡å­—è¨±ä¹…ã€‚", dim: "AO", dir: 1 },
    { text: "6.åœ¨æ’éšŠååº—å‰ï¼Œè‹¥äººæ½®å¤ªå¤šä½ æœƒæœæ–·æ›ä¸€é–“è€Œéå …æŒç­‰å¾…ã€‚", dim: "AO", dir: 1 },
    { text: "7.åŸ·è¡Œä»»å‹™æ™‚ï¼Œä½ å‚¾å‘å…ˆè¡Œå‹•å†ä¿®æ­£ï¼Œä¸æ±‚ä¸€é–‹å§‹å°±å®Œç¾ç„¡ç¼ºã€‚", dim: "AO", dir: 1 },
    { text: "8.å°æ–¼ä¸ç†Ÿæ‚‰çš„ç†è²¡æˆ–æŠ•è³‡ï¼Œè½èµ·ä¾†ä¸éŒ¯ä½ é¡˜æ„å…ˆå°é¡å˜—è©¦ã€‚", dim: "AO", dir: 1 },
    { text: "9.çœ‹åˆ°æ¸…å–®ä¸Šçš„å¾…è¾¦äº‹é …ï¼Œä½ æœƒç«‹åˆ»å‹•æ‰‹è™•ç†ä¸å–œæ­¡æ‹–å»¶ã€‚", dim: "AO", dir: 1 },
    { text: "10.ä½ çš„ç”Ÿæ´»ç©ºé–“ä¸ä¸€å®šè¦äº•ç„¶æœ‰åºï¼Œéš¨æ€§å¥½æ‹¿å°ä½ æ›´é‡è¦ã€‚", dim: "AO", dir: 1 },
    { text: "11.æœ‹å‹å¿ƒæƒ…ä¸å¥½æ™‚ï¼Œä½ çš„ç¬¬ä¸€åæ‡‰æ˜¯å…ˆå®‰æ’«æƒ…ç·’çµ¦äºˆæ“æŠ±ã€‚", dim: "HC", dir: 1 },
    { text: "12.çœ‹æ„Ÿäººçš„é›»å½±æˆ–å»£å‘Šæ™‚ï¼Œä½ å¾ˆå®¹æ˜“ç”¢ç”Ÿå…±é³´ç”šè‡³çœ¼çœ¶æ³›ç´…ã€‚", dim: "HC", dir: 1 },
    { text: "13.åœ¨é™Œç”Ÿç¤¾äº¤å ´åˆï¼Œä½ æœƒä¸»å‹•å¾®ç¬‘ä¸¦é‡‹æ”¾è¦ªåˆ‡çš„ä¿¡è™Ÿã€‚", dim: "HC", dir: 1 },
    { text: "14.ä»–äººå°ä½ çš„ç¬¬ä¸€å°è±¡é€šå¸¸æ˜¯ã€Œæº«æš–ã€å¥½ç›¸è™•ã€æ²’æ¶å­ã€ã€‚", dim: "HC", dir: 1 },
    { text: "15.æ‹’çµ•åˆ¥äººçš„è«‹æ±‚æ™‚ï¼Œä½ å…§å¿ƒå¾€å¾€æœƒæ„Ÿåˆ°æ„§ç–šä¸å®‰ã€‚", dim: "HC", dir: 1 },
    { text: "16.ä½ èªç‚ºé€ç¦®çš„å¿ƒæ„èˆ‡å¡ç‰‡æº«åº¦ï¼Œé æ¯”ç¦®ç‰©æœ¬èº«çš„å¯¦ç”¨æ€§é‡è¦ã€‚", dim: "HC", dir: 1 },
    { text: "17.èˆ‡äººåˆä½œå‡ºéŒ¯æ™‚ï¼Œä½ æœƒå…ˆé¡§åŠå°æ–¹é¢å­ï¼Œç”¨å©‰è½‰çš„æ–¹å¼æºé€šã€‚", dim: "HC", dir: 1 },
    { text: "18.åƒåŠ èšæœƒæ™‚ï¼Œä½ æœƒç©æ¥µäº¤æ–°æœ‹å‹ï¼Œäº«å—ç†±é¬§çš„æ°›åœã€‚", dim: "HC", dir: 1 },
    { text: "19.çœ‹åˆ°è·¯é‚Šå¼±å°çš„ç”Ÿå‘½éœ€è¦å¹«åŠ©ï¼Œä½ æœƒæœ‰å¼·çƒˆçš„å…±æ„Ÿèˆ‡æ†æ†«ã€‚", dim: "HC", dir: 1 },
    { text: "20.é¢å°åˆ¥äººçš„è®šç¾ï¼Œä½ æœƒæ„Ÿåˆ°ç”±è¡·é–‹å¿ƒä¸¦çµ¦äºˆç†±æƒ…å›é¥‹ã€‚", dim: "HC", dir: 1 }
];
// åˆ†æè³‡æ–™åº«
const analysisDB = {
    "BASE": {
        "INTJ": { title: "å»ºç¯‰å¸«", core: "ä½ æ“æœ‰å¼·å¤§çš„æ„å¿—èˆ‡ç¨ç«‹æ€è€ƒèƒ½åŠ›ï¼Œè¿½æ±‚æ•ˆç‡ï¼Œæ˜¯å¤©ç”Ÿçš„æˆ°ç•¥å®¶ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šåŸƒéš†Â·é¦¬æ–¯å…‹ã€å°¼é‡‡" },
        "INTP": { title: "é‚è¼¯å­¸å®¶", core: "ä½ å°ç†è«–æœ‰è‘—ä¸æ‡ˆç†±æƒ…ï¼Œæ¯”èµ·ç¾å¯¦ï¼Œä½ æ›´æ´»åœ¨æ¦‚å¿µä¸–ç•Œä¸­ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šæ¯”çˆ¾Â·è“‹èŒ²ã€æ„›å› æ–¯å¦" },
        "ENTJ": { title: "æŒ‡æ®å®˜", core: "å…·å‚™å¼·å¤§é ˜å°åŠ›èˆ‡é è¦‹ï¼Œèƒ½è¿…é€Ÿæœæ–·åœ°å¸¶é ˜åœ˜éšŠé”æˆç›®æ¨™ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šè³ˆä¼¯æ–¯ã€æ’’åˆ‡çˆ¾å¤«äºº" },
        "ENTP": { title: "è¾¯è«–å®¶", core: "è…¦ä¸­å……æ»¿æ–°ç©é»å­ï¼Œå–œæ­¡æŒ‘æˆ°ç¾ç‹€ï¼Œåœ¨ç¢°æ’ä¸­å°‹æ±‚å‰µæ–°ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šè‰¾è¿ªç”Ÿã€é‹¼éµäºº" },
        "INFJ": { title: "æå€¡è€…", core: "å®‰éœè€Œæ·±æ²‰çš„ç†æƒ³ä¸»ç¾©è€…ï¼Œæ“æœ‰æ•é–±æ´å¯ŸåŠ›ï¼Œæ¸´æœ›æ”¹è®Šä¸–ç•Œã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šé¦¬ä¸è·¯å¾·é‡‘ã€æŸæ‹‰åœ–" },
        "INFP": { title: "èª¿è§£è€…", core: "æº«æŸ”å¯Œæœ‰åŒç†å¿ƒçš„å¤¢æƒ³å®¶ï¼Œå …å®ˆå…§åœ¨åƒ¹å€¼ï¼Œå°‹æ‰¾ç”Ÿæ´»æ„ç¾©ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šèå£«æ¯”äºã€JKç¾…ç³" },
        "ENFJ": { title: "ä¸»äººå…¬", core: "å……æ»¿æ„ŸæŸ“åŠ›çš„é ˜è¢–ï¼Œå–„æ–¼é¼“èˆäººå¿ƒï¼Œå¸¶é ˜å¤§çœ¾èµ°å‘å’Œè«§ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šæ­æ™®æ‹‰ã€æ­å·´é¦¬" },
        "ENFP": { title: "ç«¶é¸è€…", core: "è‡ªç”±å¥”æ”¾çš„éˆé­‚ï¼Œå°ç”Ÿæ´»å……æ»¿å¥½å¥‡ï¼Œæ“…é•·æ¿€ç™¼ä»–äººæ½›èƒ½ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šè¿ªå£«å°¼ã€å°å‹å‹ƒé“å°¼" },
        "ISTJ": { title: "ç‰©æµå¸«", core: "å‹™å¯¦å¯é ï¼Œè²¬ä»»æ„Ÿå¼·ã€‚é‡è¦–ç§©åºèˆ‡å‚³çµ±ï¼Œæ˜¯ç¤¾æœƒçš„ä¸­æµç ¥æŸ±ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šå‚‘å¤«è²ä½æ–¯ã€è¯ç››é “" },
        "ISFJ": { title: "å®ˆè­·è€…", core: "æº«å’Œå …æ¯…ï¼Œç¸½æ˜¯é»˜é»˜é—œæ‡·ä»–äººï¼Œç´°å¿ƒç¶­è­·å‘¨åœäººçš„ç¦ç¥‰ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šå¾·è•¾èä¿®å¥³ã€å‡±ç‰¹ç‹å¦ƒ" },
        "ESTJ": { title: "ç¸½ç®¡", core: "å‚‘å‡ºçš„çµ„ç¹”è€…ï¼Œæ³¨é‡äº‹å¯¦èˆ‡è¦å‰‡ï¼ŒåŸ·è¡ŒåŠ›æ¥µé«˜ä¸”äº•ç„¶æœ‰åºã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šæ´›å…‹è²å‹’ã€å¸Œæ‹‰è•Š" },
        "ESFJ": { title: "åŸ·æ”¿å®˜", core: "ç†±æƒ…å‹å¥½çš„ç¤¾äº¤å°ˆå®¶ï¼Œé‡è¦–å’Œè«§ï¼Œæ˜¯å»ºç«‹ç¤¾å€è¯çµçš„é—œéµã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šæ³°å‹’çµ²ã€ä¼‘å‚‘å…‹æ›¼" },
        "ISTP": { title: "é‘‘è³å®¶", core: "å†·éœä¸”å……æ»¿å¥½å¥‡å¿ƒï¼Œå–œæ­¡å‹•æ‰‹è§£æ±ºå•é¡Œï¼Œé©æ‡‰èƒ½åŠ›æ¥µå¼·ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šéº¥å¯å–¬ä¸¹ã€å°ç¬¬å®‰ç´ç“Šæ–¯" },
        "ISFP": { title: "è—è¡“å®¶", core: "ä½èª¿ä¸”å¯Œæœ‰ç¾æ„Ÿï¼Œç†±æ„›æ„Ÿå®˜é«”é©—ï¼Œç”¨ç¨ç‰¹æ–¹å¼è¡¨é”æ„Ÿå—ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šèŠæ˜‚ç´å¤šã€è‰¾è–‡å…’" },
        "ESTP": { title: "ä¼æ¥­å®¶", core: "å……æ»¿æ´»åŠ›çš„å†’éšªå®¶ï¼Œæ´»åœ¨ç•¶ä¸‹ï¼Œå°æ©Ÿæœƒæ•éŠ³ï¼Œåœ¨è¡Œå‹•ä¸­å­¸ç¿’ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šå·æ™®ã€ç‘ªä¸¹å¨œ" },
        "ESFP": { title: "è¡¨æ¼”è€…", core: "å¤©ç”Ÿè¡¨æ¼”è€…ï¼Œå……æ»¿æ¨‚è¶£ï¼Œèƒ½é»ç‡ƒæ°£æ°›ï¼Œè®“ç•¶ä¸‹è®Šå¾—ç²¾å½©ã€‚<br>ã€ä»£è¡¨äººç‰©ã€‘ï¼šè‰¾çˆ¾é “å¼·ã€ç‘ªéº—è“®å¤¢éœ²" }
    },
    "ADVANCE": {
        "ISTJ-AH": { title: "è¡Œå‹•æ´¾ç®¡å®¶", core: "å …å®šä¸”æº«æš–...", decision: "å¿«é€Ÿæœæ–·", life: "ç†±æƒ…å¾…äºº", inner: "å®ˆè­·ç§©åº" },
        // ... 64ç¨® ...
    }
};

let userName = "";
let currentQuestions = [];
let currentIndex = 0;
let userScores = { EI: 0, SN: 0, TF: 0, JP: 0, AO: 0, HC: 0 };
let scoreHistory = [];
let mode = ""; // 'base' or 'advance'
let tempBaseType = "";

function startFlow(flowType) {
    userName = document.getElementById('user-name-input').value.trim() || "ç¥ç§˜å˜‰è³“";
    if (flowType === 'new') {
        mode = "base";
        currentQuestions = mbtiBaseQuestions;
    } else {
        mode = "advance";
        tempBaseType = document.getElementById('known-type').value;
        currentQuestions = advanceQuestions;
    }
    initQuiz();
}

function initQuiz() {
    currentIndex = 0;
    scoreHistory = [];
    document.getElementById('quiz-intro').style.display = 'none';
    document.getElementById('quiz-content').style.display = 'block';
    renderQuestion();
}

function renderQuestion() {
    const q = currentQuestions[currentIndex];
    document.getElementById('q-text').innerText = q.text;
    const progress = ((currentIndex + 1) / currentQuestions.length) * 100;
    document.getElementById('progress-bar').style.width = progress + "%";
    document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${currentQuestions.length}`;
    document.getElementById('prev-btn').style.visibility = currentIndex > 0 ? 'visible' : 'hidden';
}

function handleAnswer(val) {
    const q = currentQuestions[currentIndex];
    const pts = val * (q.dir || 1);
    userScores[q.dim] += pts;
    scoreHistory.push({ dim: q.dim, pts: pts });

    setTimeout(() => {
        if (currentIndex < currentQuestions.length - 1) {
            currentIndex++;
            renderQuestion();
        } else {
            finishCurrentStep();
        }
    }, 300);
}

function goBack() {
    if (currentIndex > 0) {
        currentIndex--;
        const last = scoreHistory.pop();
        userScores[last.dim] -= last.pts;
        renderQuestion();
    }
}
function toggleReturnModal(show) {
    document.getElementById('return-modal').style.display = show ? 'flex' : 'none';
}

function finishCurrentStep() {
    if (mode === "base") {
        // ç®—å‡ºä¸»äººæ ¼
        tempBaseType = (userScores.EI >= 0 ? "E" : "I") + (userScores.SN >= 0 ? "S" : "N") + 
                       (userScores.TF >= 0 ? "T" : "F") + (userScores.JP >= 0 ? "J" : "P");
        document.getElementById('advance-confirm-modal').style.display = 'flex';
    } else {
        showFinalResult("ADVANCE");
    }
}

function closeModalAndShowBase() {
    document.getElementById('advance-confirm-modal').style.display = 'none';
    showFinalResult("BASE");
}

function continueToAdvance() {
    document.getElementById('advance-confirm-modal').style.display = 'none';
    mode = "advance";
    currentQuestions = advanceQuestions;
    currentIndex = 0;
    scoreHistory = []; // æ¸…ç©ºé€²éšé¡Œçš„æ­·å²
    // é‡ç½® AO, HC åˆ†æ•¸
    userScores.AO = 0; userScores.HC = 0;
    renderQuestion();
}

function showFinalResult(type) {
    document.getElementById('quiz-content').style.display = 'none';
    document.getElementById('result-page').style.display = 'block';
    document.getElementById('res-user-name').innerText = `å—æª¢è€…ï¼š${userName}`;

    let code, data, html = "";
    
    // --- ã€æ–°å¢ã€‘è‡ªå‹•åˆ¤å®šé¡è‰²é‚è¼¯ ---
    const base4 = tempBaseType; // å–å¾—å››ç¢¼ï¼Œä¾‹å¦‚ ENFP
    const middleTwo = base4.substring(1, 3); // å–å¾— NF, NT ç­‰
    const headerEl = document.querySelector('.result-header');
    
    // å…ˆç§»é™¤æ‰€æœ‰å¯èƒ½çš„é¡è‰²é¡åˆ¥
    headerEl.classList.remove('theme-nt', 'theme-nf', 'theme-sj', 'theme-sp');
    
    // æ ¹æ“š MBTI å¤§é¡æ±ºå®šé¡è‰²
    if (middleTwo === "NT") {
        headerEl.classList.add('theme-nt');
    } else if (middleTwo === "NF") {
        headerEl.classList.add('theme-nf');
    } else if (base4.endsWith('J')) { 
        // åªè¦æ˜¯ SJ çµå°¾éƒ½æ­¸é¡ç‚ºå®ˆè­·è€…è—
        headerEl.classList.add('theme-sj');
    } else {
        // å‰©ä¸‹çš„ SP çµå°¾æ­¸é¡ç‚ºæ¢éšªå®¶æ©˜
        headerEl.classList.add('theme-sp');
    }
    // --------------------------------

    if (type === "BASE") {
        code = tempBaseType;
        data = analysisDB.BASE[code] || { title: "MBTI äººæ ¼", core: "è§£æè¼‰å…¥ä¸­..." };
        html = `<div class="analysis-section"><h4>æ ¸å¿ƒç‰¹è³ª</h4><p>${data.core}</p></div>`;
    } else {
        const sub = (userScores.AO >= 0 ? "A" : "O") + (userScores.HC >= 0 ? "H" : "C");
        code = `${tempBaseType}-${sub}`;
        data = analysisDB.ADVANCE[code] || { title: "é€²éšäºå‹", core: "å…§å®¹é–‹ç™¼ä¸­...", decision: "...", life: "...", inner: "..." };
        html = `
            <div class="analysis-section"><h4>æ ¸å¿ƒæ€§æ ¼</h4><p>${data.core}</p></div>
            <div class="analysis-section"><h4>æ±ºç­–é¢¨æ ¼</h4><p>${data.decision}</p></div>
            <div class="analysis-section"><h4>ç¤¾äº¤ç”Ÿæ´»</h4><p>${data.life}</p></div>
            <div class="analysis-section"><h4>å…§åœ¨å‹•åŠ›</h4><p>${data.inner}</p></div>
        `;
    }

    document.getElementById('res-full-code').innerText = code;
    document.getElementById('res-title').innerText = data.title;
    document.getElementById('analysis-body').innerHTML = html;

    // ç”Ÿæˆåœ–å¡
    setTimeout(() => {
        html2canvas(document.getElementById('capture-area'), { scale: 2 }).then(canvas => {
            const wrapper = document.getElementById('final-image-wrapper');
            wrapper.innerHTML = "";
            const img = new Image();
            img.src = canvas.toDataURL("image/png");
            img.style.width = "100%";
            img.style.borderRadius = "20px";
            wrapper.appendChild(img);

            // --- ã€æ–°å¢ã€‘å‹•æ…‹æ’å…¥æç¤ºæ–‡å­— ---
            const hint = document.createElement('div');
            hint.className = 'save-hint';
            hint.innerHTML = '<i class="fa-solid fa-hand-pointer"></i> ğŸ’¡ é•·æŒ‰ä¸Šæ–¹åœ–ç‰‡å³å¯å„²å­˜æˆ–åˆ†äº«å ±å‘Š';
            wrapper.appendChild(hint);
            // --------------------------------

            document.getElementById('capture-area').style.display = "none";
        });
    }, 800);
}</script>
</body>
</html>
