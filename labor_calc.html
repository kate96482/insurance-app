<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€€ä¼‘é‡‘ç¼ºå£å…¨è§£æ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #DE6262; --secondary: #FFB88C; --text: #4A3728; --bg: #F0EDE9; --success: #2F855A; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 450px; margin: auto; padding-top: 40px; }
        .header-nav { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; }
        .back-home { text-decoration: none; color: var(--primary); font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .fast-link { text-decoration: none; color: white; background: var(--primary); font-size: 0.8rem; padding: 6px 12px; border-radius: 20px; font-weight: bold; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        h2 { color: var(--primary); margin-top: 0; font-size: 1.4rem; text-align: center; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; color: var(--primary); }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #E8E2D9; box-sizing: border-box; font-size: 1rem; outline: none; }
        .range-container { display: flex; align-items: center; gap: 15px; }
        input[type=range] { flex: 1; accent-color: var(--primary); }
        .range-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); min-width: 50px; }
        .hint { font-size: 0.75rem; color: #888; margin-top: 5px; }
        .policy-tag { font-size: 0.75rem; color: #DE6262; font-weight: bold; margin-top: 3px; display: block; }
        .btn { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 10px; }
        #result { display: none; margin-top: 25px; }
        .canvas-container { margin-bottom: 20px; text-align: center; }
        #output-image { width: 100%; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .save-tip { font-size: 0.8rem; color: #888; margin-top: 8px; }
        .btn-advanced { background: linear-gradient(135deg, #2F855A, #48BB78); margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; color: white; padding: 15px; border-radius: 12px; font-weight: bold; }
        #old-years-status { font-size: 0.75rem; margin-top: 6px; font-weight: 500; display: block; line-height: 1.4; }
    </style>
</head>
<body>

<div class="header-nav">
    <a href="index.html" class="back-home"><i class="fa-solid fa-house"></i> è¿”å›é¦–é </a>
    <a href="step2.html" class="fast-link"><i class="fa-solid fa-bolt"></i> ç›´æ¥è©¦ç®—å„ªé€€æ–¹æ¡ˆ</a>
</div>

<div class="container">
    <div class="card">
        <h2><i class="fa-solid fa-hourglass-half"></i> é€€ä¼‘é‡‘ç¼ºå£è§£æ</h2>
        
        <div class="input-group">
            <label>å‡ºç”Ÿå¹´ (æ°‘åœ‹)</label>
            <input type="number" id="birth-year" placeholder="ä¾‹å¦‚ï¼š75" value="75">
        </div>

        <div class="input-group">
            <label>æ°‘åœ‹ 97 å¹´å‰æ˜¯å¦æœ‰å‹ä¿å¹´è³‡ï¼Ÿ</label>
            <select id="has-old-years">
                <option value="yes">æ˜¯ (å…·å‚™ä¸€æ¬¡è«‹é ˜è³‡æ ¼)</option>
                <option value="no">å¦ (åƒ…èƒ½é¸æ“‡æœˆé ˜å¹´é‡‘)</option>
            </select>
            <div id="old-years-status"></div>
        </div>

        <div class="input-group">
            <label>é è¨ˆé€€ä¼‘å¹´é½¡</label>
            <div class="range-container">
                <input type="range" id="retire-age-slider" min="50" max="70" value="65">
                <span class="range-val" id="age-val">65æ­²</span>
            </div>
            <span class="policy-tag" id="policy-desc">æ³•å®šé€€ä¼‘å¹´é½¡ (100%é ˜å–)</span>
            <div class="hint" id="legal-age-hint">æ‚¨çš„æ³•å®šé€€ä¼‘å¹´é½¡ç‚ºï¼š-- æ­²</div>
        </div>

        <div class="input-group">
            <label>ç†æƒ³é€€ä¼‘æœˆé ˜é‡‘é¡ (å…ƒ)</label>
            <input type="number" id="dream-income" value="50000">
        </div>

        <div class="input-group">
            <label>æœ€é«˜ 60 å€‹æœˆå¹³å‡æŠ•ä¿è–ªè³‡</label>
            <input type="number" id="avg-salary" value="45800">
            <div class="hint">å‹ä¿æœˆé ˜çœ‹ã€Œæœ€é«˜60å€‹æœˆã€ï¼Œä¸€æ¬¡è«‹é ˜çœ‹ã€Œæœ€å¾Œ3å¹´ã€</div>
        </div>

        <div class="input-group">
            <label>é€€ä¼‘æ™‚å‹ä¿ç¸½å¹´è³‡</label>
            <input type="number" id="years" step="0.1" value="35">
        </div>

        <button class="btn" onclick="calculateGap()">åˆ†æç¼ºå£èˆ‡ç›®æ¨™</button>

        <div id="result">
            <div class="canvas-container">
                <canvas id="resultCanvas" width="800" height="1850" style="display:none;"></canvas>
                <img id="output-image" alt="é€€ä¼‘ç¼ºå£ analysisåœ–">
                <div class="save-tip" id="save-tip"><i class="fa-regular fa-image"></i> é•·æŒ‰ä¸Šæ–¹åœ–ç‰‡å¯å„²å­˜çµæœ</div>
            </div>
            <a href="javascript:void(0)" id="advanced-btn" class="btn-advanced" onclick="goToStep2()">
                é€²å…¥é€²éšæ–¹æ¡ˆå°ç…§ <i class="fa-solid fa-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<script>
    let calculatedLabor = 0;
    const currentSystemYear = new Date().getFullYear() - 1911; 

    function getLegalRetireAge(birthYear) {
        if (birthYear <= 46) return 60;
        if (birthYear == 47) return 61;
        if (birthYear == 48) return 62;
        if (birthYear == 49) return 63;
        if (birthYear == 50) return 64;
        return 65;
    }

    const slider = document.getElementById('retire-age-slider');
    const ageVal = document.getElementById('age-val');
    const policyDesc = document.getElementById('policy-desc');
    const birthInput = document.getElementById('birth-year');
    const hasOldSelect = document.getElementById('has-old-years');
    const statusBox = document.getElementById('old-years-status');

    function updateSliderLogic() {
        const birthYear = parseInt(birthInput.value) || 75;
        const currentAge = currentSystemYear - birthYear;
        const legal = getLegalRetireAge(birthYear);
        const earliestAge = legal - 5; 
        
        if (birthYear >= 82) {
            hasOldSelect.value = "no";
            statusBox.innerHTML = '<span style="color:#DE6262">ğŸ’¡ æ°‘åœ‹ 97 å¹´æ™‚æ‚¨æœªæ»¿ 15 æ­²ï¼Œå¯¦å‹™ä¸Šæ¥µå°‘å…·å‚™æ­¤è³‡æ ¼ã€‚</span>';
        } else if (birthYear <= 75) {
            hasOldSelect.value = "yes";
            statusBox.innerHTML = '<span style="color:#2F855A">âœ… ç¬¦åˆå¤§ç’°å¢ƒå¹´è³‡èƒŒæ™¯ã€‚</span>';
        } else {
            statusBox.innerHTML = '<span style="color:#DD6B20">âš ï¸ ç•¶æ™‚æ‚¨ç´„ 16-21 æ­²ï¼Œè«‹ç¢ºèªå¤§å­¸æˆ–é«˜ä¸­æ‰“å·¥æ˜¯å¦æœ‰æŠ•ä¿ç´€éŒ„ã€‚</span>';
        }

        const minPossible = Math.max(50, currentAge);
        slider.min = minPossible;
        if (parseInt(slider.value) < minPossible) slider.value = minPossible;

        const val = parseInt(slider.value);
        ageVal.innerText = val + 'æ­²';
        
        let diff = val - legal;
        if (diff < 0) {
            let reducePercent = Math.min(20, Math.abs(diff) * 4);
            if (val < earliestAge) {
                policyDesc.innerText = `ææ—©é€€ä¼‘ (æœˆé ˜éœ€å¾… ${earliestAge} æ­²é–‹é ˜ï¼Œæ¸›é¡ 20%)`;
            } else {
                policyDesc.innerText = `ææ—©é ˜å– (æ¸›é¡å¹´é‡‘ -${reducePercent}%)`;
            }
            policyDesc.style.color = "#DE6262";
        } else if (diff > 0) {
            const bonus = Math.min(20, diff * 4);
            policyDesc.innerText = `å»¶å¾Œé ˜å– (å¢é¡å¹´é‡‘ +${bonus}%)`;
            policyDesc.style.color = "#2F855A";
        } else {
            policyDesc.innerText = "æ³•å®šé€€ä¼‘å¹´é½¡ (100%é ˜å–)";
            policyDesc.style.color = "#DE6262";
        }
        document.getElementById('legal-age-hint').innerText = `æ‚¨çš„æ³•å®šé€€ä¼‘å¹´é½¡ç‚ºï¼š${legal} æ­² (ç›®å‰ ${currentAge} æ­² / åŸºæº–å¹´ï¼š${currentSystemYear}å¹´)`;
    }

    slider.addEventListener('input', updateSliderLogic);
    birthInput.addEventListener('input', updateSliderLogic);

    function calculateGap() {
        const birthYear = parseInt(birthInput.value);
        const hasOld = document.getElementById('has-old-years').value;
        const dreamIncome = parseFloat(document.getElementById('dream-income').value);
        const retireAge = parseInt(slider.value);
        const avgSalary = parseFloat(document.getElementById('avg-salary').value);
        const yearsRaw = parseFloat(document.getElementById('years').value);
        const maxAge = 95;

        const legalAge = getLegalRetireAge(birthYear);
        const currentAge = currentSystemYear - birthYear;
        const earliestAge = legalAge - 5;

        let laborA_Base = (avgSalary * yearsRaw * 0.00775) + 3000;
        let laborB_Base = (avgSalary * yearsRaw * 0.0155);
        let effectiveRetireAge = Math.max(retireAge, earliestAge);
        let diff = effectiveRetireAge - legalAge;
        let ratio = 1 + (Math.max(-5, Math.min(5, diff)) * 0.04);
        
        let finalA = Math.round(laborA_Base * ratio);
        let finalB = Math.round(laborB_Base * ratio);
        
        const canMonthly = (yearsRaw >= 15);
        calculatedLabor = (canMonthly && retireAge >= earliestAge) ? Math.max(finalA, finalB) : 0;
        const monthlyAmountWhenStart = canMonthly ? Math.max(finalA, finalB) : 0;

        let baseDetail = "";
        let onceAmount = 0;
        let finalBase = 0;
        let limit = 45;

        if (hasOld === 'yes') {
            let decimalPart = yearsRaw % 1;
            let calcYears = Math.floor(yearsRaw);
            if (decimalPart > 0.5) calcYears += 1;
            else if (decimalPart > 0) calcYears += 0.5;

            let base15 = Math.min(calcYears, 15);
            let baseAbove = Math.max(0, calcYears - 15) * 2;
            let totalBase = base15 + baseAbove;
            
            if (retireAge > 60) {
                let extraYears = retireAge - 60;
                limit = Math.min(50, 45 + Math.floor(extraYears * 2));
            }
            
            finalBase = Math.min(limit, totalBase);
            onceAmount = finalBase * avgSalary;
            baseDetail = `${base15}Ã—1 + ${(baseAbove/2)}Ã—2 = ${totalBase}åŸºæ•¸ (é™${limit})`;
        }

        const vacuumYears = Math.max(0, earliestAge - retireAge);
        const vacuumCost = dreamIncome * 12 * vacuumYears;
        const postRetireYears = maxAge - Math.max(retireAge, earliestAge);
        const monthlyGap = Math.max(0, dreamIncome - monthlyAmountWhenStart);
        const totalGap = vacuumCost + (monthlyGap * 12 * postRetireYears);
        const prepareYears = Math.max(1, retireAge - currentAge);

        document.getElementById('result').style.display = 'block';

        drawResultImage({
            avgSalary, years: yearsRaw, retireAge, ratio, legalAge, canMonthly, earliestAge,
            finalLabor: calculatedLabor, monthlyAmountWhenStart, vacuumYears, vacuumCost,
            onceAmount, baseDetail, total: totalGap, 
            prepare: prepareYears, yearly: Math.round(totalGap / prepareYears), hasOld,
            dreamIncome, finalA, finalB, laborA_Base, laborB_Base
        });
    }

    function drawResultImage(d) {
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = '#DE6262'; ctx.fillRect(0, 0, canvas.width, 140);
        ctx.fillStyle = '#FFFFFF'; ctx.font = 'bold 44px "PingFang TC"'; ctx.textAlign = 'center';
        ctx.fillText('é€€ä¼‘é‡‘ç¼ºå£è§£æå ±å‘Š', canvas.width / 2, 85);

        ctx.textAlign = 'left';
        let y = 200;
        
        ctx.fillStyle = d.canMonthly ? '#DE6262' : '#AAAAAA'; 
        ctx.font = 'bold 30px "PingFang TC"';
        ctx.fillText('ä¸€ã€å‹ä¿æœˆé ˜å¹´é‡‘ (æ“‡å„ªé¸å–)', 60, y);
        y += 50;

        if (!d.canMonthly) {
            ctx.fillStyle = '#AAAAAA'; ctx.font = '22px "PingFang TC"';
            ctx.fillText('âš ï¸ å¹´è³‡æœªæ»¿ 15 å¹´ï¼Œä¸å…·å‚™æœˆé ˜è³‡æ ¼ã€‚', 80, y);
        } else {
            ctx.fillStyle = '#4A3728'; ctx.font = '20px "PingFang TC"';
            ctx.fillText(`Aå¼ï¼š(${d.avgSalary.toLocaleString()} Ã— ${d.years} Ã— 0.775% + 3000) Ã— ${d.ratio.toFixed(2)} = $ ${d.finalA.toLocaleString()}`, 80, y);
            y += 35;
            ctx.fillText(`Bå¼ï¼š(${d.avgSalary.toLocaleString()} Ã— ${d.years} Ã— 1.55%) Ã— ${d.ratio.toFixed(2)} = $ ${d.finalB.toLocaleString()}`, 80, y);
            y += 50;
            
            ctx.fillStyle = '#4A3728'; ctx.font = 'bold 32px "PingFang TC"';
            if (d.retireAge < d.earliestAge) {
                ctx.fillStyle = '#E53E3E'; ctx.fillText(`âš ï¸ éœ€å¾… ${d.earliestAge} æ­²é–‹é ˜ (é ä¼° $ ${d.monthlyAmountWhenStart.toLocaleString()}/æœˆ)`, 80, y);
            } else {
                ctx.fillText(`é ä¼°æ¯æœˆé ˜å–ï¼š$ ${d.finalLabor.toLocaleString()}`, 80, y);
            }
        }
        
        y += 120;
        ctx.fillStyle = d.hasOld === 'yes' ? '#DE6262' : '#AAAAAA';
        ctx.font = 'bold 30px "PingFang TC"';
        ctx.fillText('äºŒã€ä¸€æ¬¡è«‹é ˜èˆ‡å›æœ¬åˆ†æ', 60, y);
        y += 50;

        if (d.hasOld === 'yes') {
            ctx.fillStyle = '#4A3728'; ctx.font = 'bold 32px "PingFang TC"';
            ctx.fillText(`ä¸€æ¬¡é ˜ç¸½é¡ï¼š$ ${d.onceAmount.toLocaleString()}`, 80, y);
            y += 45;
            ctx.font = '22px "PingFang TC"';
            ctx.fillText(`(${d.baseDetail})`, 80, y);
            
            y += 70;
            let totalWaitAndRun = ( (d.onceAmount / (d.monthlyAmountWhenStart * 12)) + d.vacuumYears ).toFixed(1);
            ctx.fillStyle = '#2F855A'; ctx.font = 'bold 24px "PingFang TC"';
            ctx.fillText(`ğŸ’¡ æ±ºç­–ï¼šè‡ªé€€ä¼‘èµ·ç®—éœ€ ${totalWaitAndRun} å¹´å›æœ¬`, 80, y);
            y += 35;
            ctx.fillStyle = '#718096'; ctx.font = '16px "PingFang TC"';
            ctx.fillText(`è¨ˆç®—å¼ï¼š${d.vacuumYears}(ç©ºçª—æœŸ) + (${d.onceAmount.toLocaleString()} Ã· (${d.monthlyAmountWhenStart.toLocaleString()}Ã—12))`, 80, y);
        } else {
            ctx.fillStyle = '#AAAAAA'; ctx.font = '22px "PingFang TC"';
            ctx.fillText('âš ï¸ æ‚¨ä¸å…·å‚™ä¸€æ¬¡é ˜è³‡æ ¼ (æ°‘åœ‹97å¹´å‰ç„¡å¹´è³‡)ã€‚', 80, y);
        }

        y += 150;
        ctx.fillStyle = '#DE6262'; ctx.font = 'bold 30px "PingFang TC"';
        ctx.fillText('ä¸‰ã€é€€ä¼‘è³‡é‡‘ç¼ºå£ (å«ç©ºçª—æœŸæ™‚é–“æˆæœ¬)', 60, y);
        y += 50;
        
        if (d.vacuumYears > 0) {
            ctx.fillStyle = '#FFF5F5'; ctx.fillRect(60, y, 680, 100);
            ctx.fillStyle = '#E53E3E'; ctx.font = 'bold 22px "PingFang TC"';
            ctx.fillText(`â— ç©ºçª—æœŸ (${d.retireAge}~${d.earliestAge}æ­²)ï¼šéœ€è‡ªå‚™ $ ${d.vacuumCost.toLocaleString()}`, 80, y + 55);
            y += 130;
        }

        ctx.fillStyle = '#FFF5F5'; ctx.fillRect(60, y, 680, 160);
        ctx.fillStyle = '#DE6262'; ctx.textAlign = 'center'; ctx.font = 'bold 36px "PingFang TC"';
        ctx.fillText('æœ€çµ‚é€€ä¼‘ç¼ºå£', canvas.width / 2, y + 60);
        ctx.font = 'bold 60px "PingFang TC"'; ctx.fillText(`$ ${d.total.toLocaleString()}`, canvas.width / 2, y + 130);

        y += 240;
        ctx.fillStyle = '#F0FFF4'; ctx.fillRect(60, y, 680, 180);
        ctx.fillStyle = '#2F855A'; ctx.font = 'bold 32px "PingFang TC"';
        ctx.fillText(`è·é›¢é€€ä¼‘å‰© ${d.prepare} å¹´ï¼Œæ¯å¹´éœ€å­˜ï¼š`, canvas.width / 2, y + 60);
        ctx.font = 'bold 55px "PingFang TC"'; ctx.fillText(`$ ${d.yearly.toLocaleString()}`, canvas.width / 2, y + 135);

        y += 240; 
        ctx.fillStyle = '#888'; ctx.font = 'bold 22px "PingFang TC"'; ctx.textAlign = 'center';
        ctx.fillText('ç”±ã€Œå°é‚¦æ‰‹ã€è²¡å‹™åˆ†æå·¥å…·ç”¢å‡º', canvas.width / 2, y);

        // --- ä¸‹é¢é€™æ®µæ˜¯é—œéµï¼šæ ¹æ“š y (æœ€å¾Œä¸€è¡Œå­—çš„ä½ç½®) é‡æ–°è£åˆ‡é«˜åº¦ ---
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = canvas.width;
        finalCanvas.height = y + 80; // y æ˜¯æœ€å¾Œä¸€è¡Œå­—çš„é«˜åº¦ï¼Œ+80 æ˜¯ç•™ä¸€é»é»åº•é‚Šæ¯”è¼ƒå¥½çœ‹
        const fctx = finalCanvas.getContext('2d');
        fctx.drawImage(canvas, 0, 0); // æŠŠé•·ç•«å¸ƒçš„å…§å®¹ã€Œè²¼ã€åˆ°é€™å€‹å‰›å¥½é«˜åº¦çš„æ–°ç•«å¸ƒä¸Š

        const img = document.getElementById('output-image');
        img.src = finalCanvas.toDataURL('image/png'); // æ”¹ç”¨æ–°ç•«å¸ƒç”¢å‡ºåœ–ç‰‡
        // -------------------------------------------------------

        img.style.display = 'block';
        img.scrollIntoView({ behavior: 'smooth' });
    }

    function goToStep2() {
        localStorage.setItem('retired_currentAge', currentSystemYear - parseInt(birthInput.value));
        localStorage.setItem('retired_dreamIncome', document.getElementById('dream-income').value);
        localStorage.setItem('retired_laborIncome', calculatedLabor);
        localStorage.setItem('retired_retireAge', slider.value);
        window.location.href = `step2.html`;
    }
    window.onload = updateSliderLogic;
</script>
</body>
</html>

