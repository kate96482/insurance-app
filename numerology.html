<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>生命靈數 - 流年優化互動版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --m-blue: #4CC9F0; --m-pink: #F72585;
            --m-purple: #7209B7; --m-mint: #B5EAD7; --bg: #F8F9FA;
            --primary: #7209B7;
        }

        body { 
            font-family: "Microsoft JhengHei", sans-serif; 
            background: var(--bg); 
            margin: 0; padding: 10px;
            color: #333;
        }

        .back-home {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            color: var(--primary);
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 999;
        }

        .container { 
            max-width: 450px;
            margin: auto; 
            background: white; 
            padding: 15px; 
            border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
        }
        
        h2 { color: var(--m-purple); margin: 5px 0 15px 0; font-size: 1.4rem; text-align: center; }
        .input-box { background: #F1F3F5; padding: 10px; border-radius: 15px; margin-bottom: 10px; }
        .mode-toggle { display: flex; gap: 5px; margin-bottom: 8px; }
        .btn-mode { flex: 1; padding: 8px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #DEE2E6; font-size: 0.85rem; }
        .btn-mode.active { background: var(--m-blue); color: white; }
        .input-row { display: flex; gap: 4px; justify-content: center; }
        input, select { padding: 8px; border-radius: 8px; border: 1px solid #DDD; font-size: 0.9rem; flex: 1; min-width: 0; outline: none; }
        .process-box { background: #fff; border: 1px solid var(--m-blue); border-radius: 12px; padding: 8px; margin-bottom: 10px; text-align: center; display: none; }
        .formula-text { color: var(--m-purple); font-weight: bold; font-size: 0.85rem; }

        .grid-wrapper { position: relative; width: 90%; margin: 15px auto; }
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
        .grid-item { 
            background: #FFF; border-radius: 15px; border: 2px solid #F1F3F5; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; z-index: 2; cursor: pointer; aspect-ratio: 1/1; 
        }
        .num-label { font-size: 1.5rem; font-weight: 900; color: #ced4da; z-index: 10; }
        .active-num .num-label { color: var(--m-purple); }
        .yearly-active .num-label { color: var(--m-blue) !important; }

        #line-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3; }
        .dashed-line { stroke: var(--m-pink); stroke-width: 3; stroke-dasharray: 5; opacity: 0.6; }
        .yearly-line { stroke: var(--m-blue); stroke-dasharray: 3; opacity: 0.8; } /* 流年產生的連線顏色 */

        .circles-wrap { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .circle { position: absolute; border: 2px solid var(--m-pink); border-radius: 50%; opacity: 0.5; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle.yearly { border-color: var(--m-blue); opacity: 0.8; border-width: 3px; }
        .c1 { width: 45%; height: 45%; } .c2 { width: 65%; height: 65%; } .c3 { width: 85%; height: 85%; } .c4 { width: 95%; height: 95%; }
        
        .triangle-marker { position: absolute; bottom: 4px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 12px solid var(--m-blue); display: none; z-index: 5; }
        .active-destiny .triangle-marker { display: block; }

        .info-card, .line-section, .yearly-card { background: #fff; border-radius: 15px; padding: 12px; margin-top: 10px; border: 1px solid var(--m-mint); text-align: left; display: none; font-size: 0.85rem; }
        .line-section { background: #fdf2f8; border-color: var(--m-pink); border-style: dashed; display: block; }
        .yearly-card { display: block; border-color: var(--m-blue); background: #f0faff; }
        .timeline-container { display: flex; overflow-x: auto; gap: 10px; padding: 10px 5px; scrollbar-width: none; }
        .timeline-container::-webkit-scrollbar { display: none; }
        .timeline-item { flex: 0 0 52px; text-align: center; background: #fff; padding: 8px 0; border-radius: 12px; border: 1px solid #e0e0e0; cursor: pointer; transition: 0.3s; }
        .timeline-item.active { background: var(--m-blue); color: white; border-color: var(--m-blue); transform: scale(1.05); font-weight: bold; }
        .tm-num { font-weight: 900; font-size: 1.1rem; display: block; }
        .tm-year { font-size: 0.6rem; opacity: 0.8; }

        .line-tag { display: inline-block; background: var(--m-pink); color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.75rem; margin: 0 4px 4px 0; font-weight: bold;}
        .line-tag.yearly-boost { background: var(--m-blue); }
        .status-tag { font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; margin-left: 5px; font-weight: bold;}
        .tag-active { background: var(--m-mint); color: #2d6a4f; }
        .tag-strong { background: var(--m-pink); color: white; }
    </style>
</head>
<body>

<a href="index.html" class="back-home"><i class="fa-solid fa-house"></i> 返回首頁</a>

<div class="container">
    <h2><i class="fa-solid fa-star-and-crescent"></i> 生命靈數全解析</h2>

    <div class="input-box">
        <div class="mode-toggle">
            <button class="btn-mode active" id="btn-select" onclick="switchMode('select')">選單選擇</button>
            <button class="btn-mode" id="btn-manual" onclick="switchMode('manual')">民國碼</button>
        </div>
        <div id="mode-select" class="input-row">
            <select id="sel-y"></select><select id="sel-m"></select><select id="select-d"></select>
        </div>
        <div id="mode-manual" class="input-row" style="display:none;">
            <input type="tel" id="roc-date" placeholder="例: 0800101" maxlength="7">
            <button class="btn-mode active" style="flex:none; width:60px;" onclick="calculate()">計算</button>
        </div>
    </div>

    <div id="processBox" class="process-box"><div id="formula" class="formula-text"></div></div>

    <div class="grid-wrapper">
        <svg id="line-canvas"></svg>
        <div class="grid-container" id="grid">
            <script>
                for(let i=1; i<=9; i++) {
                    document.write(`<div class="grid-item" data-n="${i}" id="grid-${i}" onclick="showDetail(${i})"><div class="triangle-marker"></div><span class="num-label">${i}</span><div class="circles-wrap"></div></div>`);
                }
            </script>
        </div>
    </div>

    <div id="detailCard" class="info-card">
        <div id="detailTitle" style="font-weight:bold; color:var(--m-pink); margin-bottom:5px;"></div>
        <div id="detailContent" style="color: #555; line-height:1.4;"></div>
    </div>

    <div id="lineBox" class="line-section">
        <div id="lineTags"></div>
        <div id="lineDetail" style="margin-top: 8px; line-height: 1.5; color: #555;"></div>
    </div>

    <div id="yearlyBox" class="yearly-card">
        <div id="yearlyTitle" style="font-weight:bold; color:var(--m-blue); margin-bottom:2px;"></div>
        <p style="font-size:0.7rem; color:#888; margin: 0 0 5px 0;">點擊下方年份查看流年如何影響你的命盤：</p>
        <div class="timeline-container" id="yearlyTimeline"></div>
        <div id="yearlyContent" style="color: #555; line-height:1.4; padding-top: 10px; border-top: 1px dashed #ced4da;"></div>
    </div>
</div>

<script>
    let currentMode = 'select';
    let lastSelectedNum = null;
    let globalCounts = {};
    let currentYearlyNum = null; // 儲存當前選中的流年數字

    const numDetailData = {
        1: { has: "具備獨立性與開創力，有主見。", none: "缺數：較依賴他人，果斷力不足。", strong: "凸顯：過於自我，難以溝通。" },
        2: { has: "觀察力細膩，擅長協調合作。", none: "缺數：人際敏感度低，直白易傷人。", strong: "凸顯：過於依賴，情緒波動大。" },
        3: { has: "富有創意幽默，表達能力強。", none: "缺數：思考嚴肅，缺乏生活熱情。", strong: "凸顯：缺乏耐心，容易虎頭尾。" },
        4: { has: "做事踏實有條理，追求穩定。", none: "缺數：生活較無章法，缺乏安全感。", strong: "凸顯：極度保守固執，害怕改變。" },
        5: { has: "熱愛自由冒險，適應力極強。", none: "缺數：性格被動，害怕變動與未知。", strong: "凸顯：定性不足，情緒起伏劇烈。" },
        6: { has: "富有責任感，擅長照顧他人。", none: "缺數：不擅長表達情感，責任感弱。", strong: "凸顯：過度干涉他人，要求完美。" },
        7: { has: "具備邏輯分析力，追求真理。", none: "缺數：不愛深入思考，判斷較表象。", strong: "凸顯：疑心病重，顯得孤僻冷淡。" },
        8: { has: "執行力強，具備商業管理直覺。", none: "缺數：缺乏野心與競爭力。", strong: "凸顯：權力慾過強，給人壓力大。" },
        9: { has: "擁有博愛精神，豐富想像力。", none: "缺數：處事現實，缺乏夢想熱忱。", strong: "凸顯：過於不切實際，容易幻想。" }
    };

    const yearlyData = {
        1: "開創年：全新的開始。適合設定九年大計，主動出擊，嘗試新事物。",
        2: "協調年：放慢節奏的合作期。重點在於人際關係與細節處理，適合溝通。",
        3: "表達年：社交與創意的一年。運氣提升，適合學習、表演或社交。",
        4: "紮根年：穩定與建設的一年。適合在專業領域深耕，需注意身體健康。",
        5: "轉折年：變革與冒險的一年。可能面臨環境變遷、轉職或長途旅行。",
        6: "責任年：家庭與奉獻的一年。重心轉向親友，適合修復關係、美化家園。",
        7: "反省年：心靈與智慧的一年。不宜向外大步擴張，適合進修、內觀自我。",
        8: "收成年：權力與物質的豐收期。過去七年的努力將見效，執行力最強。",
        9: "完成年：斷捨離與大掃除。結束不適合的關係，為下個循環清空空間。"
    };

    const primaryLines = [
        { ids: [1,2,3], name: "美感線", desc: "具備獨特審美與藝術天分。" },
        { ids: [4,5,6], name: "組織線", desc: "能在混亂中建立秩序。" },
        { ids: [7,8,9], name: "貴人線", desc: "人緣極佳，易得支持。" },
        { ids: [1,4,7], name: "物質線", desc: "重視安全感與紮實基礎。" },
        { ids: [2,5,8], name: "情感線", desc: "具強大親和力與社交影響。" },
        { ids: [3,6,9], name: "智慧線", desc: "學習力強，重視靈性思考。" },
        { ids: [1,5,9], name: "事業線", desc: "不畏困難的強大行動派。" },
        { ids: [3,5,7], name: "爭議線", desc: "口才強但易招議論。" }
    ];

    const secondaryLines = [
        { ids: [2,4], name: "靈巧線", desc: "處事靈活，應變力強。" },
        { ids: [2,6], name: "和平線", desc: "擅長營造和諧氣氛。" },
        { ids: [6,8], name: "財運線", desc: "對金錢資源具敏銳度。" },
        { ids: [4,8], name: "穩定執行線", desc: "意志堅定，耐力十足。" }
    ];

    const sy = document.getElementById('sel-y'), sm = document.getElementById('sel-m'), sd = document.getElementById('select-d');
    for(let i=2030; i>=1920; i--) sy.options.add(new Option(i+'年', i));
    for(let i=1; i<=12; i++) sm.options.add(new Option(i+'月', i));
    for(let i=1; i<=31; i++) sd.options.add(new Option(i+'日', i));
    sy.value = 1990; [sy, sm, sd].forEach(el => el.onchange = calculate);

    function switchMode(m) {
        currentMode = m;
        document.getElementById('mode-select').style.display = m === 'select' ? 'flex' : 'none';
        document.getElementById('mode-manual').style.display = m === 'manual' ? 'flex' : 'none';
        document.getElementById('btn-select').classList.toggle('active', m === 'select');
        document.getElementById('btn-manual').classList.toggle('active', m === 'manual');
        calculate();
    }

    function showDetail(n) {
        const card = document.getElementById('detailCard');
        if (lastSelectedNum === n && card.style.display === 'block') { card.style.display = 'none'; lastSelectedNum = null; return; }
        card.style.display = 'block';
        const count = globalCounts[n] || 0;
        let status = count === 0 ? '<span class="status-tag">無</span>' : 
                     count >= 3 ? '<span class="status-tag tag-strong">強</span>' : '<span class="status-tag tag-active">有</span>';
        if(n === currentYearlyNum) status += ' <span class="status-tag" style="background:var(--m-blue);color:white;">流年進駐</span>';
        document.getElementById('detailTitle').innerHTML = `數字 ${n} 解析 ${status}`;
        document.getElementById('detailContent').innerText = count === 0 ? numDetailData[n].none : count >= 3 ? numDetailData[n].strong : numDetailData[n].has;
        lastSelectedNum = n;
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function getSingleDigit(n) {
        while (n > 9) { n = n.toString().split("").map(Number).reduce((a, b) => a + b, 0); }
        return n;
    }

    // 優化重點：點擊流年時，重新渲染九宮格與連線
    window.updateYearlyDetail = function(num, year, el) {
        currentYearlyNum = num;
        document.querySelectorAll('.timeline-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('yearlyContent').innerHTML = `
            <div style="font-weight:bold; color:var(--m-purple); margin-bottom:5px;">${year} 年（流年數字 ${num}）</div>
            ${yearlyData[num]}
        `;
        renderGridAndLines(); // 重新畫圖
    }

    function calculate() {
        let y, m, d;
        if(currentMode === 'select') { 
            y = parseInt(sy.value); m = parseInt(sm.value); d = parseInt(sd.value); 
        } else {
            const roc = document.getElementById('roc-date').value;
            if(roc.length < 7) return;
            y = parseInt(roc.substring(0,3)) + 1911; m = parseInt(roc.substring(3,5)); d = parseInt(roc.substring(5,7));
        }
        const dateStr = `${y}${m.toString().padStart(2,'0')}${d.toString().padStart(2,'0')}`;
        const birthNums = dateStr.split("").map(Number).filter(n => n !== 0);
        let allNums = [...birthNums]; 
        let sum = birthNums.reduce((a, b) => a + b, 0);
        let formula = birthNums.join('+') + `=${sum}`;
        sum.toString().split("").forEach(s => allNums.push(Number(s)));
        while (sum > 9) {
            sum = sum.toString().split("").map(Number).reduce((a, b) => a + b, 0);
            formula += `=${sum}`;
            allNums.push(sum);
        }
        document.getElementById('processBox').style.display = 'block';
        document.getElementById('formula').innerText = formula;
        const counts = {};
        allNums.forEach(n => { if(n > 0) counts[n] = (counts[n] || 0) + 1; });
        globalCounts = counts;
        globalSum = sum;

        // 計算初始流年
        const now = new Date(); 
        const birthdayThisYear = new Date(now.getFullYear(), m - 1, d);
        let baseYear = (now < birthdayThisYear) ? now.getFullYear() - 1 : now.getFullYear();
        const calcYearly = (targetYear) => {
            const s1 = targetYear.toString().split("").map(Number).reduce((a,b)=>a+b, 0);
            const s2 = m.toString().split("").map(Number).reduce((a,b)=>a+b, 0);
            const s3 = d.toString().split("").map(Number).reduce((a,b)=>a+b, 0);
            return getSingleDigit(s1 + s2 + s3);
        };
        currentYearlyNum = calcYearly(baseYear);
        
        let timelineHtml = "";
        for(let i=0; i<9; i++) {
            let tYear = baseYear + i;
            let tNum = calcYearly(tYear);
            timelineHtml += `<div class="timeline-item ${i===0?'active':''}" onclick="updateYearlyDetail(${tNum}, ${tYear}, this)">
                <span class="tm-num">${tNum}</span><span class="tm-year">${tYear}</span></div>`;
        }
        document.getElementById('yearlyTimeline').innerHTML = timelineHtml;
        document.getElementById('yearlyContent').innerHTML = `<div style="font-weight:bold; color:var(--m-purple); margin-bottom:5px;">${baseYear} 年（流年數字 ${currentYearlyNum}）</div>${yearlyData[currentYearlyNum]}`;
        
        renderGridAndLines();
    }

    function renderGridAndLines() {
        const counts = globalCounts;
        const sum = globalSum;
        const yearlyNum = currentYearlyNum;

        // 更新格子
        document.querySelectorAll('.grid-item').forEach(item => {
            const n = parseInt(item.getAttribute('data-n'));
            const wrap = item.querySelector('.circles-wrap');
            wrap.innerHTML = "";
            item.className = 'grid-item';
            if (n === sum) item.classList.add('active-destiny');
            
            // 原生圈圈
            if(counts[n]) {
                item.classList.add('active-num');
                for(let i=1; i<=Math.min(counts[n], 4); i++) {
                    const c = document.createElement('div');
                    c.className = `circle c${i}`;
                    wrap.appendChild(c);
                }
            }
            // 流年圈圈 (如果原生沒有圈，或是補足空缺)
            if(n === yearlyNum) {
                item.classList.add('yearly-active');
                const yc = document.createElement('div');
                yc.className = `circle yearly c${Math.min((counts[n]||0)+1, 4)}`;
                wrap.appendChild(yc);
            }
        });

        // 繪製連線並判斷流年影響
        const svg = document.getElementById('line-canvas');
        const wrapper = document.querySelector('.grid-wrapper');
        const wrapperRect = wrapper.getBoundingClientRect();
        svg.innerHTML = "";
        let tags = "", details = "";
        
        [...primaryLines, ...secondaryLines].forEach((l, idx) => {
            const hasOriginal = l.ids.every(id => counts[id]);
            const hasWithYearly = l.ids.every(id => counts[id] || id === yearlyNum);

            if (hasWithYearly) {
                const isYearlyBoost = !hasOriginal; // 這是靠流年補才有的連線
                const lineNums = l.ids.join('-');
                const isPrimary = idx < 8;
                
                tags += `<span class="line-tag ${isYearlyBoost?'yearly-boost':''}" style="${!isPrimary && !isYearlyBoost?'background:var(--m-blue)':''}">${lineNums} ${l.name}${isYearlyBoost?' (流年補數)':''}</span>`;
                details += `<div style="margin-bottom:5px;">${isYearlyBoost?'★':(isPrimary?'●':'○')} <b>${lineNums} ${l.name}</b>：${l.desc}</div>`;
                
                const el1 = document.getElementById(`grid-${l.ids[0]}`).getBoundingClientRect();
                const el2 = document.getElementById(`grid-${l.ids[l.ids.length-1]}`).getBoundingClientRect();
                
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", el1.left + el1.width/2 - wrapperRect.left);
                line.setAttribute("y1", el1.top + el1.height/2 - wrapperRect.top);
                line.setAttribute("x2", el2.left + el2.width/2 - wrapperRect.left);
                line.setAttribute("y2", el2.top + el2.height/2 - wrapperRect.top);
                line.setAttribute("class", `dashed-line ${isYearlyBoost?'yearly-line':''}`);
                svg.appendChild(line);
            }
        });
        document.getElementById('lineTags').innerHTML = tags || '<span style="color:#999">目前無達成連線</span>';
        document.getElementById('lineDetail').innerHTML = details || '當前無特殊連線。';
    }
    
    window.addEventListener('resize', renderGridAndLines);
    calculate();
</script>
</body>
</html>
