<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小邦手 工具箱</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary-blue: #005a92; --bg-gray: #f4f7f9; --accent-red: #d9534f; 
            /* 生命靈數配色 */
            --m-blue: #4CC9F0; --m-pink: #F72585; --m-purple: #7209B7; --m-mint: #B5EAD7;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-gray); padding-bottom: 80px; }

        /* --- 框架與導覽 --- */
        .page { display: none; padding: 10px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .container { max-width: 1000px; margin: auto; background: white; padding: 15px; border-radius: 12px; }
        h2 { color: var(--primary-blue); text-align: center; margin: 10px 0; font-size: 1.3rem; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 9999; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; cursor: pointer; font-size: 12px; }
        .nav-item.active { color: var(--primary-blue); font-weight: bold; }

        /* --- 防癌試算專用 CSS --- */
        .input-group { background: #eef6fb; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .gender-selector { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .gender-btn { flex: 1; max-width: 120px; padding: 10px; border: 2px solid #ccc; border-radius: 8px; background: white; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .gender-btn.active { border-color: var(--primary-blue); background: var(--primary-blue); color: white; }
        .age-controls { font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .age-controls input[type="range"] { width: 150px; }
        .age-controls input[type="number"] { width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 2px; }
        .result-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .result-cards .card { background: #fff; border: 1px solid #e1e8ed; padding: 8px 2px; border-radius: 6px; text-align: center; }
        .result-cards .card .title { font-size: 0.75rem; color: #777; }
        .result-cards .card .value { font-size: 0.9rem; font-weight: bold; color: var(--accent-red); }
        .chart-wrapper { display: flex; flex-direction: row; gap: 10px; margin: 15px auto; justify-content: center; max-width: 100%; }
        .chart-box { flex: 1; max-width: 300px; width: 48%; background: #fff; padding: 5px; border-radius: 8px; border: 1px solid #eee; display: flex; flex-direction: column; }
        .chart-label { font-size: 0.85rem; font-weight: bold; color: var(--primary-blue); text-align: center; margin-bottom: 5px; }
        .chart-container { position: relative; width: 100%; aspect-ratio: 1 / 1.1; }
        .benefit-section { background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #eee; margin: 15px 0; }
        .benefit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .benefit-item { font-size: 0.8rem; border-left: 3px solid var(--primary-blue); padding-left: 8px; line-height: 1.3; }
        .grid-container-plans { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .plan-item { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 8px 2px; text-align: center; cursor: pointer; }
        .plan-item i { font-size: 18px; color: var(--primary-blue); margin-bottom: 4px; display: block; }
        .plan-item span { font-size: 0.7rem; font-weight: bold; display: block; }
        #detail-panel { margin-top: 15px; padding: 12px; background: #fafafa; border: 1px dashed var(--primary-blue); border-radius: 8px; display: none; font-size: 0.85rem; }

        /* --- 生命靈數專用 CSS --- */
        .num-input-box { background: #F1F3F5; padding: 10px; border-radius: 15px; margin-bottom: 10px; }
        .mode-toggle { display: flex; gap: 5px; margin-bottom: 8px; }
        .btn-mode { flex: 1; padding: 6px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #DEE2E6; font-size: 0.85rem; }
        .btn-mode.active { background: var(--m-blue); color: white; }
        .num-input-row { display: flex; gap: 4px; justify-content: center; }
        .grid-wrapper { position: relative; width: 85%; margin: 15px auto; }
        .num-grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
        .grid-item { background: #FFF; border-radius: 15px; border: 2px solid #F1F3F5; display: flex; align-items: center; justify-content: center; position: relative; z-index: 2; cursor: pointer; aspect-ratio: 1/1; }
        .num-label { font-size: 1.5rem; font-weight: 900; color: #ced4da; z-index: 10; }
        .active-num .num-label { color: var(--m-purple); }
        #line-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3; }
        .dashed-line { stroke: var(--m-pink); stroke-width: 2.5; stroke-dasharray: 5; opacity: 0.5; }
        .circles-wrap { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .circle { position: absolute; border: 2px solid var(--m-pink); border-radius: 50%; opacity: 0.5; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .c1 { width: 45%; height: 45%; } .c2 { width: 62%; height: 62%; } .c3 { width: 79%; height: 79%; } .c4 { width: 95%; height: 95%; }
        .triangle-marker { position: absolute; bottom: 4px; width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 16px solid rgba(76, 201, 240, 0.5); display: none; z-index: 5; }
        .active-destiny .triangle-marker { display: block; }
        .info-card { background: #fff; border-radius: 15px; padding: 12px; margin-top: 10px; border: 1px solid var(--m-mint); text-align: left; display: none; font-size: 0.85rem; }
        .timeline-container { display: flex; overflow-x: auto; gap: 10px; padding: 15px 5px; scrollbar-width: none; }
        .timeline-item { flex: 0 0 52px; text-align: center; background: #fff; padding: 10px 0; border-radius: 12px; border: 1px solid #e0e0e0; cursor: pointer; transition: all 0.3s; }
        .timeline-item.active { background: var(--m-blue); color: white; border-color: var(--m-blue); transform: scale(1.1); font-weight: bold; }
        .tm-num { font-weight: 900; font-size: 1.2rem; display: block; }
        .tm-year { font-size: 0.65rem; opacity: 0.8; }
        
        @media (max-width: 768px) {
            .chart-wrapper { flex-direction: column; align-items: center; }
            .chart-box { width: 100%; max-width: 100%; }
        }
    </style>
</head>
<body>

    <div id="home-page" class="page active">
        <h2 style="margin-top:50px;">小邦手 工具箱</h2>
        <div style="max-width: 400px; margin: auto; padding:20px; display: grid; gap: 20px;">
            <div class="container" style="padding:40px; cursor:pointer; text-align: center; border:1px solid #eee;" onclick="switchPage('calc-page', document.querySelector('.nav-item:nth-child(2)'))">
                <i class="fa-solid fa-calculator" style="font-size:50px; color:var(--primary-blue); margin-bottom:15px;"></i>
                <p style="font-size:1.5rem; font-weight:bold;">防癌試算</p>
            </div>
            <div class="container" style="padding:40px; cursor:pointer; text-align: center; border:1px solid #eee;" onclick="switchPage('numer-page', document.querySelector('.nav-item:nth-child(3)'))">
                <i class="fa-solid fa-star-and-crescent" style="font-size:50px; color:var(--m-purple); margin-bottom:15px;"></i>
                <p style="font-size:1.5rem; font-weight:bold;">生命靈數</p>
            </div>
        </div>
    </div>

    <div id="calc-page" class="page">
        <div class="container">
            <h2>防癌無憂即時試算</h2>
            <div class="input-group">
                <div class="gender-selector">
                    <button class="gender-btn active" onclick="setGender('male', this)">男性</button>
                    <button class="gender-btn" onclick="setGender('female', this)">女性</button>
                </div>
                <div class="age-controls">
                    <input type="number" id="ageInput" value="30" min="30" max="64" oninput="syncAge('input')"> 歲
                    <input type="range" id="ageSlider" min="30" max="64" value="30" oninput="syncAge('slider')">
                </div>
            </div>
            <div class="result-cards">
                <div class="card"><div class="title">目前年齡</div><div id="resAge" class="value">30</div></div>
                <div class="card"><div class="title">首年費用</div><div id="firstYear" class="value">-</div></div>
                <div class="card"><div class="title">續年費用</div><div id="secondYear" class="value">-</div></div>
                <div class="card"><div class="title">10年總計</div><div id="accum10" class="value">-</div></div>
                <div class="card"><div class="title">20年總計</div><div id="accum20" class="value">-</div></div>
                <div class="card"><div class="title">30年總計</div><div id="accum30" class="value">-</div></div>
            </div>
            <div class="chart-wrapper">
                <div class="chart-box">
                    <div class="chart-label">存活率對比</div>
                    <div class="chart-container"><canvas id="survivalChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="chart-label" id="cancerChartTitle">男性前十大癌症</div>
                    <div class="chart-container"><canvas id="cancerChart"></canvas></div>
                </div>
            </div>
            <div class="benefit-section">
                <div class="benefit-grid">
                    <div class="benefit-item">早期治癒 90%+</div>
                    <div class="benefit-item">避免債務黑洞</div>
                    <div class="benefit-item">從治療轉篩檢</div>
                    <div class="benefit-item">保障花在刀口</div>
                </div>
            </div>
            <h3 style="text-align:center; font-size:0.95rem; margin-top: 10px;">年度8擇1精準篩檢</h3>
            <div class="grid-container-plans">
                <div class="plan-item" onclick="showPlanDetail(0, this)"><i class="fa-solid fa-dna"></i><span>CTC 循環</span></div>
                <div class="plan-item" onclick="showPlanDetail(1, this)"><i class="fa-solid fa-shield-virus"></i><span>肝甲狀腺</span></div>
                <div class="plan-item" onclick="showPlanDetail(2, this)"><i class="fa-solid fa-mars"></i><span>男性十大</span></div>
                <div class="plan-item" onclick="showPlanDetail(3, this)"><i class="fa-solid fa-venus"></i><span>女性十大</span></div>
                <div class="plan-item" onclick="showPlanDetail(4, this)"><i class="fa-solid fa-eye"></i><span>特殊癌</span></div>
                <div class="plan-item" onclick="showPlanDetail(5, this)"><i class="fa-solid fa-magnifying-glass-plus"></i><span>隱匿危機</span></div>
                <div class="plan-item" onclick="showPlanDetail(6, this)"><i class="fa-solid fa-heart-pulse"></i><span>癌心血管</span></div>
                <div class="plan-item" onclick="showPlanDetail(7, this)"><i class="fa-solid fa-brain"></i><span>腦部神經</span></div>
            </div>
            <div id="detail-panel"><div id="detTitle" style="font-weight:bold; color:var(--primary-blue);"></div><div id="detBody" style="margin:5px 0;"></div><div id="detMethod" style="color:var(--accent-red); font-weight:bold;"></div></div>
        </div>
    </div>

    <div id="numer-page" class="page">
        <div class="container">
            <h2>生命靈數全解析</h2>
            <div class="num-input-box">
                <div class="mode-toggle">
                    <button class="btn-mode active" id="btn-select" onclick="switchNumMode('select')">選單選擇</button>
                    <button class="btn-mode" id="btn-manual" onclick="switchNumMode('manual')">民國碼</button>
                </div>
                <div id="mode-select-num" class="num-input-row">
                    <select id="sel-y"></select><select id="sel-m"></select><select id="sel-d"></select>
                </div>
                <div id="mode-manual-num" class="num-input-row" style="display:none;">
                    <input type="tel" id="roc-date" placeholder="例: 0800101" maxlength="7">
                    <button class="btn-mode active" style="flex:none; width:60px;" onclick="numCalculate()">計算</button>
                </div>
            </div>
            <div id="processBox" style="text-align:center; margin-bottom:10px; font-size:0.8rem; color:var(--m-purple); font-weight:bold;"></div>
            <div class="grid-wrapper">
                <svg id="line-canvas"></svg>
                <div class="num-grid-container" id="num-grid">
                    <script>
                        for(let i=1; i<=9; i++) {
                            document.write(`<div class="grid-item" data-n="${i}" id="grid-${i}" onclick="showNumDetail(${i})"><div class="triangle-marker"></div><span class="num-label">${i}</span><div class="circles-wrap"></div></div>`);
                        }
                    </script>
                </div>
            </div>
            <div id="numDetailCard" class="info-card">
                <div id="numDetailTitle" style="font-weight:bold; color:var(--m-pink); margin-bottom:5px;"></div>
                <div id="numDetailContent" style="color: #555; line-height:1.4;"></div>
            </div>
            <div id="lineBox" class="info-card" style="display:block; border-color: var(--m-pink); background: #fdf2f8; border-style: dashed;">
                <div id="lineTags"></div>
                <div id="lineDetail" style="margin-top: 8px; line-height: 1.5; color: #555;"></div>
            </div>
            <div id="yearlyBox" class="info-card" style="display:block; border-color: var(--m-blue); background: #f0faff;">
                <div id="yearlyTitle" style="font-weight:bold; color:var(--m-blue); margin-bottom:2px;">流年週期循環</div>
                <div class="timeline-container" id="yearlyTimeline"></div>
                <div id="yearlyContent" style="color: #555; line-height:1.4; padding-top: 10px; border-top: 1px dashed #ced4da;"></div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home-page', this)"><i class="fa-solid fa-house"></i><span>首頁</span></div>
        <div class="nav-item" onclick="switchPage('calc-page', this)"><i class="fa-solid fa-chart-pie"></i><span>防癌試算</span></div>
        <div class="nav-item" onclick="switchPage('numer-page', this)"><i class="fa-solid fa-star-and-crescent"></i><span>生命靈數</span></div>
    </nav>

    <script>
        /* --- 共通導覽 --- */
        function switchPage(pageId, element) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            element.classList.add('active');
            if(pageId === 'calc-page') { setTimeout(initCharts, 50); }
            if(pageId === 'numer-page') { setTimeout(numCalculate, 50); }
        }

        /* --- 功能一：防癌試算邏輯 (完全保留您的數據) --- */
        let currentGender = 'male';
        let survivalChart, cancerChart;
        const planDetails = [
            { title: "CTC 循環腫瘤細胞檢測", body: "捕捉血液中微小病灶。", method: "方式：抽血 10ml。" },
            { title: "肝與甲狀腺深度檢測", body: "針對代謝問題預防病變。", method: "方式：超音波+血液。" },
            { title: "男性十大癌症基因風險", body: "檢測遺傳變異機率。", method: "方式：口腔抹片。" },
            { title: "女性十大癌症基因風險", body: "乳腺、卵巢基因篩查。", method: "方式：口腔抹片。" },
            { title: "特殊癌症早期警示", body: "針對胰臟、膽囊等癌症。", method: "方式：血液精密定序。" },
            { title: "隱匿危機癌症監測", body: "偵測長期潛伏病變。", method: "方式：全身癌症指標。" },
            { title: "綜合癌症與心血管風險", body: "涵蓋癌症與血管硬化。", method: "方式：抽血檢測。" },
            { title: "腦部與神經功能篩查", body: "預防早發失智。", method: "方式：認知測試。" }
        ];
        const rates = {
            male: { first: { 30: 8464, 35: 8761, 40: 9321, 45: 10199, 50: 11290 , 55: 12620, 60: 14175 }, renew: { 30: 8563, 35: 8960, 40: 9706, 45: 10878, 50: 12331 , 55: 14105, 60: 16180, 65: 18263, 70: 20023, 75: 23153 } },
            female: { first: { 30: 8696, 35: 9161, 40: 9805, 45: 10688, 50: 11238 , 55: 11643, 60: 12184 }, renew: { 30: 8872, 35: 9494, 40: 10353, 45: 11529, 50: 12262 , 55: 12803, 60: 13524, 65: 14244, 70: 14411, 75: 15865 } }
        };

        function setGender(gender, btn) {
            currentGender = gender;
            document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            calculateInsurance();
        }
        function syncAge(type) {
            const s = document.getElementById('ageSlider'), i = document.getElementById('ageInput');
            if (type==='slider') i.value=s.value; else s.value=i.value;
            calculateInsurance();
        }
        function initCharts() {
            const isMobile = window.innerWidth < 768;
            const commonOpt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: isMobile?8:12, font: { size: isMobile?9:12 } } } } };
            if(survivalChart) survivalChart.destroy();
            if(cancerChart) cancerChart.destroy();
            survivalChart = new Chart(document.getElementById('survivalChart').getContext('2d'), {
                type: 'doughnut', data: { labels: ['早期(90%)', '晚期(20%)'], datasets: [{ data: [90, 20], backgroundColor: ['#28a745', '#dc3545'] }] }, options: commonOpt
            });
            cancerChart = new Chart(document.getElementById('cancerChart').getContext('2d'), {
                type: 'pie', data: getCancerData(currentGender), options: commonOpt
            });
            calculateInsurance();
        }
        function getCancerData(gender) {
            return gender === 'male' ? 
                { labels: ['大腸癌','肺癌','肝癌','口腔癌','攝護腺癌','食道癌','胃癌','皮膚癌','淋巴癌','膀胱癌'], datasets: [{ data: [15,14,12,10,9,8,7,6,5,4], backgroundColor: ['#003f5c','#2f4b7c','#665191','#a05195','#d45087','#f95d6a','#ff7c43','#ffa600','#488f31','#de425b'] }] } :
                { labels: ['乳癌','大腸癌','肺癌','甲狀腺癌','子宮癌','肝癌','卵巢癌','皮膚癌','胃癌','淋巴癌'], datasets: [{ data: [25,12,11,10,8,7,6,5,4,3], backgroundColor: ['#d9534f','#e57373','#ef9a9a','#f48fb1','#ce93d8','#b2dfdb','#81c784','#fff176','#ffb74d','#a1887f'] }] };
        }
        function calculateInsurance() {
            const g = currentGender, a = parseInt(document.getElementById('ageInput').value);
            document.getElementById('resAge').innerText = a;
            document.getElementById('cancerChartTitle').innerText = (g === 'male' ? '男' : '女') + '性前十大癌症';
            if(cancerChart) { cancerChart.data = getCancerData(g); cancerChart.update(); }
            const getR = (gen, age, isF) => { const t = isF ? rates[gen].first : rates[gen].renew; const keys = Object.keys(t).map(Number).sort((x,y)=>y-x); for(let k of keys) { if(age>=k) return t[k]; } return t[30]; };
            const f = getR(g, a, true);
            document.getElementById('firstYear').innerText = "$" + f.toLocaleString();
            document.getElementById('secondYear').innerText = "$" + getR(g, a+1, false).toLocaleString();
            let t10=0, t20=0, t30=0;
            for(let i=0; i<30; i++) {
                let cur = a+i; if(cur>75) break;
                let p = (i===0)?f:getR(g, cur, false);
                if(i<10) t10+=p; if(i<20) t20+=p; if(i<30) t30+=p;
            }
            document.getElementById('accum10').innerText = "$" + t10.toLocaleString();
            document.getElementById('accum20').innerText = "$" + t20.toLocaleString();
            document.getElementById('accum30').innerText = "$" + t30.toLocaleString();
        }
        function showPlanDetail(idx, el) {
            document.querySelectorAll('.plan-item').forEach(i => i.style.borderColor = "#eee");
            el.style.borderColor = "var(--primary-blue)";
            document.getElementById('detail-panel').style.display = 'block';
            document.getElementById('detTitle').innerText = planDetails[idx].title;
            document.getElementById('detBody').innerText = planDetails[idx].body;
            document.getElementById('detMethod').innerText = planDetails[idx].method;
        }

        /* --- 功能二：生命靈數邏輯 (完全保留您的解析與繪圖) --- */
        let numMode = 'select';
        let numGlobalCounts = {};
        const numDetailData = {
            1: { has: "具備獨立性與開創力，有主見。", none: "缺數：較依賴他人，果斷力不足。", strong: "凸顯：過於自我，難以溝通。" },
            2: { has: "觀察力細膩，擅長協調合作。", none: "缺數：人際敏感度低，直白易傷人。", strong: "凸顯：過於依賴，情緒波動大。" },
            3: { has: "富有創意幽默，表達能力強。", none: "缺數：思考嚴肅，缺乏生活熱情。", strong: "凸顯：缺乏耐心，容易虎頭蛇尾。" },
            4: { has: "做事踏實有條理，追求穩定。", none: "缺數：生活較無章法，缺乏安全感。", strong: "凸顯：極度保守固執，害怕改變。" },
            5: { has: "熱愛自由冒險，適應力極強。", none: "缺數：性格被動，害怕變動與未知。", strong: "凸顯：定性不足，情緒起伏劇烈。" },
            6: { has: "富有責任感，擅長照顧他人。", none: "缺數：不擅長表達情感，責任感弱。", strong: "凸顯：過度干涉他人，要求完美。" },
            7: { has: "具備邏輯分析力，追求真理。", none: "缺數：不愛深入思考，判斷較表象。", strong: "凸顯：疑心病重，顯得孤僻冷淡。" },
            8: { has: "執行力強，具備商業管理直覺。", none: "缺數：缺乏野心與競爭力。", strong: "凸顯：權力慾過強，給人壓力大。" },
            9: { has: "擁有博愛精神，豐富想像力。", none: "缺數：處事現實，缺乏夢想熱忱。", strong: "凸顯：過於不切實際，容易幻想。" }
        };
        const yearlyData = {
            1: "開創年：全新的開始。適合設定九年大計，主動出擊。", 2: "協調年：放慢節奏的合作期。重點在於人際關係與細節處理。",
            3: "表達年：社交與創意的一年。運氣提升，適合學習或社交。", 4: "紮根年：穩定與建設的一年。適合深耕，壓力可能較大。",
            5: "轉折年：變革與冒險的一年。可能面臨環境變遷或轉職。", 6: "責任年：家庭與奉獻的一年。重心轉向親友，承擔責任。",
            7: "反省年：心靈與智慧的一年。適合進修、研究、內觀自我。", 8: "收成年：過去七年的努力將在此時見效，執行力最強。", 9: "完成年：斷捨離與大掃除。結束不再適合的關係，宜收尾。"
        };
        const primaryLines = [
            { ids: [1,2,3], name: "美感線", desc: "具備獨特審美與藝術天分。" }, { ids: [4,5,6], name: "組織線", desc: "能在混亂中建立秩序。" },
            { ids: [7,8,9], name: "貴人線", desc: "人緣極佳，易得支持。" }, { ids: [1,4,7], name: "物質線", desc: "重視安全感與紮實基礎。" },
            { ids: [2,5,8], name: "情感線", desc: "具強大親和力與社交影響。" }, { ids: [3,6,9], name: "智慧線", desc: "學習力強，重視靈性思考。" },
            { ids: [1,5,9], name: "事業線", desc: "不畏困難的強大行動派。" }, { ids: [3,5,7], name: "爭議線", desc: "口才強但易招議論。" }
        ];
        const secondaryLines = [
            { ids: [2,4], name: "靈巧線", desc: "處事靈活，應變力強。" }, { ids: [2,6], name: "和平線", desc: "擅長營造和諧氣氛。" },
            { ids: [6,8], name: "財運線", desc: "對金錢資源具敏銳度。" }, { ids: [4,8], name: "穩定執行線", desc: "意志堅定，耐力十足。" }
        ];

        function initNumSelectors() {
            const sy = document.getElementById('sel-y'), sm = document.getElementById('sel-m'), sd = document.getElementById('sel-d');
            for(let i=2026; i>=1920; i--) sy.options.add(new Option(i+'年', i));
            for(let i=1; i<=12; i++) sm.options.add(new Option(i+'月', i));
            for(let i=1; i<=31; i++) sd.options.add(new Option(i+'日', i));
            sy.value = 1990; [sy, sm, sd].forEach(el => el.onchange = numCalculate);
        }
        function switchNumMode(m) {
            numMode = m;
            document.getElementById('mode-select-num').style.display = m === 'select' ? 'flex' : 'none';
            document.getElementById('mode-manual-num').style.display = m === 'manual' ? 'flex' : 'none';
            document.getElementById('btn-select').classList.toggle('active', m === 'select');
            document.getElementById('btn-manual').classList.toggle('active', m === 'manual');
            numCalculate();
        }
        function showNumDetail(n) {
            const card = document.getElementById('numDetailCard');
            card.style.display = 'block';
            const count = numGlobalCounts[n] || 0;
            let status = count === 0 ? '<span style="font-size:0.7rem; background:#eee; padding:2px 5px; border-radius:4px;">無</span>' : 
                         count >= 3 ? '<span style="font-size:0.7rem; background:var(--m-pink); color:white; padding:2px 5px; border-radius:4px;">強</span>' : 
                         '<span style="font-size:0.7rem; background:var(--m-mint); color:#2d6a4f; padding:2px 5px; border-radius:4px;">有</span>';
            document.getElementById('numDetailTitle').innerHTML = `數字 ${n} 解析 ${status}`;
            document.getElementById('numDetailContent').innerText = count === 0 ? numDetailData[n].none : count >= 3 ? numDetailData[n].strong : numDetailData[n].has;
        }
        function getSingleDigit(n) {
            while (n > 9) { n = n.toString().split("").map(Number).reduce((a, b) => a + b, 0); }
            return n;
        }
        window.updateYearlyDetail = function(num, year, el) {
            document.querySelectorAll('.timeline-item').forEach(item => item.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('yearlyContent').innerHTML = `<div style="font-weight:bold; color:var(--m-purple); margin-bottom:5px;">${year} 年（流年數字 ${num}）</div>${yearlyData[num]}`;
        }
        function numCalculate() {
            let y, m, d;
            if(numMode === 'select') { 
                y = parseInt(document.getElementById('sel-y').value); 
                m = parseInt(document.getElementById('sel-m').value); 
                d = parseInt(document.getElementById('sel-d').value);
            } else {
                const roc = document.getElementById('roc-date').value;
                if(roc.length < 7) return;
                y = parseInt(roc.substring(0,3)) + 1911; m = parseInt(roc.substring(3,5)); d = parseInt(roc.substring(5,7));
            }
            const dateStr = `${y}${m.toString().padStart(2,'0')}${d.toString().padStart(2,'0')}`;
            const birthNums = dateStr.split("").map(Number).filter(n => n !== 0);
            let allNums = [...birthNums]; 
            let sum = birthNums.reduce((a, b) => a + b, 0);
            let formula = birthNums.join('+') + `=${sum}`;
            sum.toString().split("").forEach(s => allNums.push(Number(s)));
            while (sum > 9) {
                sum = sum.toString().split("").map(Number).reduce((a, b) => a + b, 0);
                formula += `=${sum}`; allNums.push(sum);
            }
            document.getElementById('processBox').innerText = formula;
            const counts = {};
            allNums.forEach(n => { if(n > 0) counts[n] = (counts[n] || 0) + 1; });
            numGlobalCounts = counts;

            document.querySelectorAll('#num-grid .grid-item').forEach(item => {
                const n = parseInt(item.getAttribute('data-n'));
                const wrap = item.querySelector('.circles-wrap');
                wrap.innerHTML = ""; item.className = 'grid-item';
                if (n === sum) item.classList.add('active-destiny');
                if(counts[n]) {
                    item.classList.add('active-num');
                    for(let i=1; i<=Math.min(counts[n], 4); i++) {
                        const c = document.createElement('div'); c.className = `circle c${i}`; wrap.appendChild(c);
                    }
                }
            });

            const svg = document.getElementById('line-canvas');
            const wrapperRect = document.querySelector('.grid-wrapper').getBoundingClientRect();
            svg.innerHTML = ""; let tags = "", details = "";
            [...primaryLines, ...secondaryLines].forEach((l, idx) => {
                if (l.ids.every(id => counts[id])) {
                    const isPrimary = idx < 8;
                    tags += `<span style="display:inline-block; background:${isPrimary?'var(--m-pink)':'var(--m-blue)'}; color:white; padding:1px 8px; border-radius:8px; font-size:0.75rem; margin:0 4px 4px 0;">${l.ids.join('-')} ${l.name}</span>`;
                    details += `<div style="margin-bottom:5px;"><b>${l.ids.join('-')} ${l.name}</b>：${l.desc}</div>`;
                    const el1 = document.getElementById(`grid-${l.ids[0]}`).getBoundingClientRect();
                    const el2 = document.getElementById(`grid-${l.ids[l.ids.length-1]}`).getBoundingClientRect();
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", el1.left + el1.width/2 - wrapperRect.left);
                    line.setAttribute("y1", el1.top + el1.height/2 - wrapperRect.top);
                    line.setAttribute("x2", el2.left + el2.width/2 - wrapperRect.left);
                    line.setAttribute("y2", el2.top + el2.height/2 - wrapperRect.top);
                    line.setAttribute("class", "dashed-line");
                    svg.appendChild(line);
                }
            });
            document.getElementById('lineTags').innerHTML = tags || '<span style="color:#999">目前無達成連線</span>';
            document.getElementById('lineDetail').innerHTML = details || '當前無特殊連線。';

            // 流年
            const now = new Date(); const currentYear = now.getFullYear();
            const birthdayThisYear = new Date(currentYear, m - 1, d);
            let baseYear = (now < birthdayThisYear) ? currentYear - 1 : currentYear;
            const calcY = (ty) => getSingleDigit(ty.toString().split("").map(Number).reduce((a,b)=>a+b,0) + m + d);
            let timelineHtml = "";
            for(let i=0; i<9; i++) {
                let tY = baseYear + i; let tN = calcY(tY);
                timelineHtml += `<div class="timeline-item ${i===0?'active':''}" onclick="updateYearlyDetail(${tN}, ${tY}, this)"><span class="tm-num">${tN}</span><span class="tm-year">${tY}</span></div>`;
            }
            document.getElementById('yearlyTimeline').innerHTML = timelineHtml;
            updateYearlyDetail(calcY(baseYear), baseYear);
        }

        /* --- 初始化 --- */
        window.onload = () => {
            initNumSelectors();
            initCharts();
            numCalculate();
        };
        window.onresize = () => { if(document.getElementById('calc-page').classList.contains('active')) initCharts(); if(document.getElementById('numer-page').classList.contains('active')) numCalculate(); };
    </script>
</body>
</html>
