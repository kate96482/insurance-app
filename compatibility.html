<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>雙人合盤分析</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --m-blue: #4CC9F0; --m-pink: #F72585;
            --m-purple: #7209B7; --m-mint: #B5EAD7; --bg: #F8F9FA;
            --primary: #7209B7;
            --line-pink: rgba(247, 37, 133, 0.45);
            --line-blue: rgba(76, 201, 240, 0.45);
        }

        body { 
            font-family: "Microsoft JhengHei", sans-serif; 
            background: var(--bg); margin: 0; padding: 10px; color: #333;
            -webkit-tap-highlight-color: transparent;
        }

        .container { 
            max-width: 450px; margin: auto; background: white; 
            padding: 15px; border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
        }
        
        h2 { color: var(--m-pink); margin: 5px 0 15px 0; font-size: 1.4rem; text-align: center; }

        /* 原本的結果卡片樣式完全保留，但截圖後會隱藏並顯示圖檔 */
        .result-card { 
            margin-top: 20px; display: none; text-align: center; 
            position: relative;
            background: #FFFFFF; padding: 20px 15px;
            border-radius: 25px;
        }

        /* 新增：最終生成的圖片容器 */
        #final-image-container { 
            display: none; 
            margin-top: 20px; 
            text-align: center; 
        }
        #final-image-container p {
            font-size: 0.85rem;
            color: var(--m-purple);
            background: #f0edff;
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        #generated-img {
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        
        .score-circle {
            width: 70px; height: 70px; border-radius: 50%; background: var(--m-pink);
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: 900; margin: 10px auto;
        }

        .grid-container { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; 
            width: 100%; aspect-ratio: 1/1; 
        }
        .grid-item { 
            background: #FFF; border: 1px solid #eee; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden;
        }
        .num-label { font-size: 0.85rem; font-weight: 900; color: #eee; z-index: 5; }
        .active-num .num-label { color: #333; }
        
        .circle { position: absolute; border: 0.8px solid; border-radius: 50%; opacity: 0.5; }
        
        canvas.line-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        .nav-header { display: flex; justify-content: space-between; align-items: center; max-width: 450px; margin: 0 auto 10px auto; }
        .back-btn { display: inline-flex; align-items: center; gap: 5px; color: var(--primary); font-weight: bold; font-size: 0.9rem; padding: 8px 15px; border-radius: 20px; background: white; box-shadow: 0 1px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .pair-input-section { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .person-box { background: #F8F9FA; padding: 12px; border-radius: 15px; border-left: 5px solid var(--m-blue); }
        .person-box.p2 { border-left-color: var(--m-pink); }
        .box-title { font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; color: #666; }
        .input-row { display: flex; gap: 5px; }
        input, select { padding: 8px; border-radius: 8px; border: 1px solid #DDD; font-size: 0.85rem; flex: 1; outline: none; }
        .calc-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--m-blue), var(--m-purple)); color: white; border: none; border-radius: 15px; font-weight: bold; font-size: 1rem; margin-top: 10px; cursor: pointer; }
        .rel-tag { display: inline-block; padding: 4px 12px; border-radius: 10px; background: var(--m-mint); color: #2d6a4f; font-weight: bold; font-size: 0.8rem; }
        .analysis-text { background: #fff; border: 1px dashed var(--m-blue); border-radius: 15px; padding: 12px; margin-top: 10px; text-align: left; line-height: 1.5; font-size: 0.85rem; }
        .circles-wrap { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .triangle-marker { position: absolute; bottom: 2px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 7px solid var(--m-blue); display: none; z-index: 6; }
        .active-destiny .triangle-marker { display: block; }
        .shared-grid-section { margin-top: 25px; background: #fdfdfd; padding: 15px; border-radius: 20px; border: 1px solid #eee; }
        .shared-grid-title { font-size: 0.9rem; font-weight: bold; color: var(--m-purple); margin-bottom: 10px; }
        .shared-grid-wrap { width: 160px; margin: 0 auto; position: relative; }
        .comparison-grid-area { display: flex; gap: 10px; margin-top: 20px; justify-content: space-between; }
        .mini-grid-wrap { flex: 1; position: relative; }
        .grid-name { font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; color: #777; }
        .grid-analysis-list { display: flex; gap: 10px; margin-top: 10px; }
        .analysis-col { flex: 1; text-align: left; font-size: 0.75rem; background: #fdfdfd; padding: 8px; border-radius: 10px; border: 1px solid #f0f0f0; }
        .ana-title { font-weight: bold; color: var(--m-purple); border-bottom: 1px solid #eee; margin-bottom: 4px; padding-bottom: 2px; }
        .ana-item { margin-bottom: 8px; color: #555; }
        .ana-sub { font-weight: bold; color: #444; display: block; }

        /* 用於後台渲染的隱藏區 */
        #offscreen-render {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 450px;
        }
    </style>
</head>
<body>

<div class="nav-header">
    <div onclick="location.reload();" class="back-btn"><i class="fa-solid fa-rotate-left"></i> 重新分析</div>
</div>

<div class="container" id="main-container">
    <h2><i class="fa-solid fa-heart"></i> 雙人合盤分析</h2>
    <div class="pair-input-section" id="input-section">
        <div class="person-box p1">
            <div class="box-title"><i class="fa-solid fa-user"></i> 第一位 (通常是你)</div>
            <div class="input-row"><select id="p1-y"></select><select id="p1-m"></select><select id="p1-d"></select></div>
        </div>
        <div class="person-box p2">
            <div class="box-title"><i class="fa-solid fa-heart"></i> 第二位 (對方)</div>
            <div class="input-row"><select id="p2-y"></select><select id="p2-m"></select><select id="p2-d"></select></div>
        </div>
        <button class="calc-btn" onclick="analyzeCompatibility()">開始計算契合度</button>
    </div>

    <div id="final-image-container">
        <p><i class="fa-solid fa-circle-down"></i> 分析完成！請長按圖片儲存分享</p>
        <img id="generated-img" src="" alt="分析結果圖">
    </div>

        <div id="resultCard" class="result-card">
        <div class="rel-tag" id="rel-type">契合模式</div>
        <div class="score-circle" id="rel-number">?</div>
        <div style="font-weight: bold; color: var(--m-purple); margin-bottom: 10px;">關係數：生命靈數 <span id="rel-num-text"></span></div>
        <div class="analysis-text" id="analysis-content"></div>

        <div class="shared-grid-section">
            <div class="shared-grid-title"><i class="fa-solid fa-layer-group"></i> 能量共盤</div>
            <div class="shared-grid-wrap"><div class="grid-container" id="grid-shared"></div></div>
        </div>

        <div class="comparison-grid-area">
            <div class="mini-grid-wrap">
                <div class="grid-name">第一位命盤</div>
                <div id="wrap-p1" style="position: relative;">
                   <div class="grid-container" id="grid-p1"></div>
                   <canvas class="line-overlay" id="canvas-p1"></canvas>
                </div>
            </div>
            <div class="mini-grid-wrap">
                <div class="grid-name">第二位命盤</div>
                <div id="wrap-p2" style="position: relative;">
                    <div class="grid-container" id="grid-p2"></div>
                    <canvas class="line-overlay" id="canvas-p2"></canvas>
                </div>
            </div>
        </div>

        <div class="grid-analysis-list">
            <div class="analysis-col" id="ana-p1"></div>
            <div class="analysis-col" id="ana-p2"></div>
        </div>
    </div>
</div>

<script>
    function initSelect(prefix) {
        const sy = document.getElementById(`${prefix}-y`), sm = document.getElementById(`${prefix}-m`), sd = document.getElementById(`${prefix}-d`);
        for(let i=2026; i>=1920; i--) sy.options.add(new Option(i+'年', i));
        for(let i=1; i<=12; i++) sm.options.add(new Option(i+'月', i));
        for(let i=1; i<=31; i++) sd.options.add(new Option(i+'日', i));
        sy.value = 1995;
    }
    initSelect('p1'); initSelect('p2');

    const lines3 = [{ids:[1,2,3], name:"美感"}, {ids:[4,5,6], name:"組織"}, {ids:[7,8,9], name:"貴人"}, {ids:[1,4,7], name:"物質"}, {ids:[2,5,8], name:"情感"}, {ids:[3,6,9], name:"智慧"}, {ids:[1,5,9], name:"事業"}, {ids:[3,5,7], name:"爭議"}];
    const lines2 = [{ ids: [2,4], name: "靈巧線" }, { ids: [2,6], name: "和平線" }, { ids: [6,8], name: "財運線" }, { ids: [4,8], name: "穩定執行線" }];
    const relData = { 1: "【開創與領導】具備強大的開拓精神，雙方在一起能共同創業或達成目標，但需注意主導權的爭奪。", 2: "【和諧與溝通】非常契合的伴侶關係，善於交流與傾聽，能像靈魂伴侶般支撐彼此。", 3: "【創意與歡樂】生活充滿樂趣與新鮮感，適合共同參與社交活動，感情生活多采多姿。", 4: "【穩定與務實】關係穩如泰山，雙方對家庭與金錢有共識，是能攜手走入婚姻的務實組合。", 5: "【自由與冒險】不喜歡束縛，能給予彼此極大的私人空間，適合一起旅行探索世界。", 6: "【責任與愛護】充滿母性與關懷，雙方極度顧家，關係中充滿溫馨與責任感。", 7: "【靈魂與智慧】著重精神交流與靈魂成長，能共同鑽研真理，建立深層的心靈連結。", 8: "【成就與物質】具備極佳的財運與執行力，兩人在事業上是最佳拍檔，能創造豐厚財富。", 9: "【大愛與夢想】關係中充滿理想主義與博愛精神，願意一起回饋社會，感情昇華至靈性層面。" };
    const numBrief = { 1: "獨立開創", 2: "溝通協調", 3: "創意表達", 4: "穩固務實", 5: "自由冒險", 6: "關懷責任", 7: "邏輯真理", 8: "執行成就", 9: "博愛夢想" };

    function getFullNumbers(y, m, d) {
        const dateStr = `${y}${m.toString().padStart(2,'0')}${d.toString().padStart(2,'0')}`;
        let birthNums = dateStr.split("").map(Number).filter(n => n !== 0);
        let allNums = [...birthNums];
        let sum = birthNums.reduce((a, b) => a + b, 0);
        sum.toString().split("").forEach(s => allNums.push(Number(s)));
        while (sum > 9) {
            sum = sum.toString().split("").map(Number).reduce((a, b) => a + b, 0);
            allNums.push(sum);
        }
        const counts = {};
        allNums.forEach(n => { counts[n] = (counts[n] || 0) + 1; });
        return { counts, destiny: sum };
    }

    function drawGrid(containerId, data, isShared = false, data2 = null) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        for(let i=1; i<=9; i++) {
            const item = document.createElement('div');
            const hasP1 = data.counts[i] > 0;
            const hasP2 = isShared && data2.counts[i] > 0;
            const isDestiny = (!isShared && data.destiny === i) || (isShared && (data.destiny === i || data2.destiny === i));
            item.className = 'grid-item' + (hasP1 || hasP2 ? ' active-num' : '') + (isDestiny ? ' active-destiny' : '');
            item.innerHTML = `<div class="triangle-marker"></div><span class="num-label">${i}</span><div class="circles-wrap"></div>`;
            const wrap = item.querySelector('.circles-wrap');
            if(!isShared) {
                if(data.counts[i]) {
                    for(let c=0; c<data.counts[i]; c++) {
                        const circle = document.createElement('div');
                        circle.className = `circle`;
                        circle.style.width = (35 + c*12) + '%';
                        circle.style.height = (35 + c*12) + '%';
                        circle.style.borderColor = "var(--m-pink)";
                        wrap.appendChild(circle);
                    }
                }
            } else {
                if(hasP1) {
                    const c1 = document.createElement('div'); c1.className = `circle`; c1.style.width = '55%'; c1.style.height = '55%'; c1.style.borderColor = "var(--m-blue)"; c1.style.borderWidth = "2px"; wrap.appendChild(c1);
                }
                if(hasP2) {
                    const c2 = document.createElement('div'); c2.className = `circle`; c2.style.width = '80%'; c2.style.height = '80%'; c2.style.borderColor = "var(--m-pink)"; c2.style.borderWidth = "2px"; wrap.appendChild(c2);
                }
            }
            container.appendChild(item);
        }
    }

    function drawLines(containerId, canvasId, data) {
        const container = document.getElementById(containerId);
        const canvas = document.getElementById(canvasId);
        const items = container.querySelectorAll('.grid-item');
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * 2; canvas.height = rect.height * 2;
        const ctx = canvas.getContext('2d');
        ctx.scale(2, 2);
        ctx.clearRect(0, 0, rect.width, rect.height);
        ctx.lineWidth = 2; ctx.setLineDash([5, 5]);

        const getCenter = (idx) => {
            const el = items[idx-1];
            const elRect = el.getBoundingClientRect();
            return { x: el.offsetLeft + el.offsetWidth / 2, y: el.offsetTop + el.offsetHeight / 2 };
        };

        lines3.forEach(l => {
            if (l.ids.every(id => data.counts[id])) {
                const p1 = getCenter(l.ids[0]), p2 = getCenter(l.ids[2]);
                ctx.beginPath(); ctx.strokeStyle = "rgba(247, 37, 133, 0.45)"; 
                ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            }
        });
        lines2.forEach(l => {
            if (l.ids.every(id => data.counts[id])) {
                const p1 = getCenter(l.ids[0]), p2 = getCenter(l.ids[1]);
                ctx.beginPath(); ctx.strokeStyle = "rgba(76, 201, 240, 0.45)";
                ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            }
        });
    }

    async function captureToImage() {
        const resultCard = document.getElementById('resultCard');
        const finalContainer = document.getElementById('final-image-container');
        const generatedImg = document.getElementById('generated-img');

        // 等待渲染穩定
        await new Promise(r => setTimeout(r, 600));
        
        html2canvas(resultCard, {
            useCORS: true,
            scale: 2,
            backgroundColor: "#FFFFFF",
            logging: false
        }).then(canvas => {
            const imageData = canvas.toDataURL("image/png", 1.0);
            generatedImg.src = imageData;
            
            // 隱藏原始 DOM，顯示圖片
            resultCard.style.display = 'none';
            document.getElementById('input-section').style.display = 'none';
            finalContainer.style.display = 'block';
            window.scrollTo(0, 0);
        });
    }

    function analyzeCompatibility() {
        const d1 = getFullNumbers(document.getElementById('p1-y').value, document.getElementById('p1-m').value, document.getElementById('p1-d').value);
        const d2 = getFullNumbers(document.getElementById('p2-y').value, document.getElementById('p2-m').value, document.getElementById('p2-d').value);
        let relNum = d1.destiny + d2.destiny;
        while (relNum > 9) relNum = relNum.toString().split("").map(Number).reduce((a, b) => a + b, 0);

        const card = document.getElementById('resultCard');
        card.style.display = 'block';
        document.getElementById('rel-number').innerText = relNum;
        document.getElementById('rel-num-text').innerText = relNum;
        document.getElementById('analysis-content').innerText = relData[relNum];

        const typeTag = document.getElementById('rel-type');
        if (d1.destiny === d2.destiny) { typeTag.innerText = "靈魂伴侶模式 (相似型)"; typeTag.style.background = "#B5EAD7"; }
        else if ((d1.destiny + d2.destiny) % 2 === 0) { typeTag.innerText = "互補成長模式 (和諧型)"; typeTag.style.background = "#FFDAC1"; }
        else { typeTag.innerText = "火花挑戰模式 (火花型)"; typeTag.style.background = "#FFB7B2"; }

        drawGrid('grid-shared', d1, true, d2);
        drawGrid('grid-p1', d1);
        drawGrid('grid-p2', d2);
        
        // 渲染完網格後畫線
        setTimeout(() => {
            drawLines('grid-p1', 'canvas-p1', d1);
            drawLines('grid-p2', 'canvas-p2', d2);
        }, 100);
        
        const renderText = (divId, data) => {
            const div = document.getElementById(divId);
            let missing = []; for(let i=1; i<=9; i++) if(!data.counts[i]) missing.push(i);
            let active3 = lines3.filter(l => l.ids.every(id => data.counts[id])).map(l => l.name);
            let active2 = lines2.filter(l => l.ids.every(id => data.counts[id])).map(l => l.name);
            div.innerHTML = `<div class="ana-title">數據解析</div><div class="ana-item"><span class="ana-sub">1.本命數 ${data.destiny}</span>${numBrief[data.destiny]}</div><div class="ana-item"><span class="ana-sub">2.缺數分析</span>${missing.join(',') || '無'}</div><div class="ana-item"><span class="ana-sub">3.連線分析</span>${[...active3, ...active2].join(',') || '無'}</div>`;
        };
        renderText('ana-p1', d1); renderText('ana-p2', d2);

        captureToImage();
    }
</script>
</body>
</html>
