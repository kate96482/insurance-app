<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精準防癌試算 - 小邦手</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #005a92; 
            --secondary: #eef6fb;
            --accent: #d9534f;
            --text: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; transition: all 0.3s ease; }
        body { margin: 0; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: #f1f5f9; color: var(--text); padding: 15px; }

        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: var(--shadow); }
        
        .back-link { text-decoration: none; color: #64748b; font-size: 0.9rem; margin-bottom: 20px; display: inline-flex; align-items: center; gap: 5px; }
        .back-link:hover { color: var(--primary); transform: translateX(-3px); }

        h2 { color: var(--primary); text-align: center; font-size: 1.6rem; margin-top: 0; margin-bottom: 25px; letter-spacing: 1px; }

        /* 控制區 */
        .control-group { background: var(--secondary); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(0,90,146,0.1); }
        .gender-selector { display: flex; gap: 15px; margin-bottom: 20px; }
        .gender-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; background: white; cursor: pointer; font-weight: bold; color: #64748b; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .gender-btn.active { background: var(--primary); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,90,146,0.3); }

        .age-control { display: flex; align-items: center; gap: 20px; padding: 5px; }
        .age-control span { font-weight: bold; min-width: 40px; }
        .age-control input[type="number"] { width: 70px; padding: 8px; border: 2px solid #cbd5e1; border-radius: 8px; text-align: center; font-size: 1.1rem; font-weight: 800; color: var(--primary); }
        .age-control input[type="range"] { flex: 1; accent-color: var(--primary); cursor: pointer; }

        /* 費用卡片 */
        .result-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .result-item { background: white; border: 1px solid #f1f5f9; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .result-item.highlight { border: 2px solid var(--primary); background: #fdfdfd; }
        .result-item .label { font-size: 0.8rem; color: #64748b; margin-bottom: 8px; font-weight: 600; }
        .result-item .value { font-size: 1.2rem; color: var(--accent); font-weight: 800; }
        .result-item.main-age .value { color: var(--primary); }

        /* 圖表區 */
        .chart-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 15px; border-radius: 15px; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); height: 350px; display: flex; flex-direction: column; }
        .chart-title { font-size: 1rem; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .chart-wrapper { flex: 1; position: relative; min-height: 0; }

        /* 篩檢按鈕 */
        .plan-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .plan-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; }
        .plan-card:hover { border-color: var(--primary); background: var(--secondary); transform: translateY(-3px); }
        .plan-card.active { border-color: var(--primary); background: var(--secondary); box-shadow: inset 0 0 0 1px var(--primary); }
        .plan-card i { font-size: 22px; color: var(--primary); margin-bottom: 8px; }
        .plan-card span { display: block; font-size: 0.8rem; font-weight: bold; color: var(--text); }

        #detail-view { margin-top: 20px; padding: 20px; background: #fff; border-left: 5px solid var(--primary); border-radius: 8px; box-shadow: var(--shadow); display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) {
            .result-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-section { grid-template-columns: 1fr; }
            .plan-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> 返回主選單</a>

    <h2>防癌無憂即時試算</h2>

    <div class="control-group">
        <div class="gender-selector">
            <button class="gender-btn active" onclick="setGender('male', this)"><i class="fa-solid fa-mars"></i> 男性</button>
            <button class="gender-btn" onclick="setGender('female', this)"><i class="fa-solid fa-venus"></i> 女性</button>
        </div>
        <div class="age-control">
            <span>年齡</span>
            <input type="number" id="ageInput" value="30" min="30" max="64" oninput="updateAge('input')">
            <input type="range" id="ageSlider" min="30" max="64" value="30" oninput="updateAge('slider')">
        </div>
    </div>

    <div class="result-grid">
        <div class="result-item main-age"><div class="label">目前年齡</div><div id="curAge" class="value">30</div></div>
        <div class="result-item"><div class="label">首年費用</div><div id="firstYear" class="value">-</div></div>
        <div class="result-item"><div class="label">續年費用</div><div id="secondYear" class="value">-</div></div>
        <div class="result-item highlight"><div class="label">10年總計</div><div id="total10" class="value">-</div></div>
        <div class="result-item highlight"><div class="label">20年總計</div><div id="total20" class="value">-</div></div>
        <div class="result-item highlight"><div class="label">30年總計(至<span id="endAge">60</span>歲)</div><div id="total30" class="value">-</div></div>
    </div>

    <div class="chart-section">
        <div class="chart-card">
            <div class="chart-title"><i class="fa-solid fa-heart-pulse"></i> 存活率關鍵差異</div>
            <div class="chart-wrapper"><canvas id="survivalChart"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-title"><i class="fa-solid fa-chart-pie"></i> <span id="cancerTitle">男性十大癌症</span></div>
            <div class="chart-wrapper"><canvas id="cancerChart"></canvas></div>
        </div>
    </div>

    <h3 style="text-align:center; margin-bottom:20px; font-size:1.1rem;">年度 8 擇 1 精準篩檢方案</h3>
    <div class="plan-grid">
        <div class="plan-card" onclick="selectPlan(0, this)"><i class="fa-solid fa-dna"></i><span>CTC 循環</span></div>
        <div class="plan-card" onclick="selectPlan(1, this)"><i class="fa-solid fa-shield-virus"></i><span>肝甲狀腺</span></div>
        <div class="plan-card" onclick="selectPlan(2, this)"><i class="fa-solid fa-mars"></i><span>男性十大</span></div>
        <div class="plan-card" onclick="selectPlan(3, this)"><i class="fa-solid fa-venus"></i><span>女性十大</span></div>
        <div class="plan-card" onclick="selectPlan(4, this)"><i class="fa-solid fa-eye"></i><span>特殊癌</span></div>
        <div class="plan-card" onclick="selectPlan(5, this)"><i class="fa-solid fa-magnifying-glass-plus"></i><span>隱匿危機</span></div>
        <div class="plan-card" onclick="selectPlan(6, this)"><i class="fa-solid fa-heart-pulse"></i><span>癌心血管</span></div>
        <div class="plan-card" onclick="selectPlan(7, this)"><i class="fa-solid fa-brain"></i><span>腦部神經</span></div>
    </div>

    <div id="detail-view">
        <div id="pTitle" style="font-weight:bold; color:var(--primary); font-size:1.1rem; margin-bottom:8px;"></div>
        <div id="pDesc" style="line-height:1.6; margin-bottom:10px;"></div>
        <div id="pMethod" style="background: var(--secondary); padding: 8px 12px; border-radius: 6px; color: var(--accent); font-weight: bold;"></div>
    </div>
</div>

<script>
    let gender = 'male';
    let sChart, cChart;
    Chart.register(ChartDataLabels); // 註冊數據標籤插件

    const plans = [
        { t: "CTC 循環腫瘤細胞檢測", d: "透過精密技術捕捉血液中微小癌細胞病灶，在腫瘤尚未成型前發現風險。", m: "檢測方式：抽血 10ml" },
        { t: "肝與甲狀腺深度檢測", d: "針對高壓族群常見的代謝與內分泌系統篩查，預防慢性病轉為惡性病變。", m: "檢測方式：超音波 + 血液指標" },
        { t: "男性十大癌症基因風險", d: "檢測先天遺傳弱點，找出家族基因中的高風險癌症標記。", m: "檢測方式：口腔抹片" },
        { t: "女性十大癌症基因風險", d: "針對乳腺、子宮等女性高風險癌症進行基因預判。", m: "檢測方式：口腔抹片" },
        { t: "特殊癌症早期警示", d: "針對胰臟、膽囊等傳統健檢死角進行高階定序篩檢。", m: "檢測方式：血液精密定序" },
        { t: "隱匿危機癌症監測", d: "偵測長期潛伏於體內的異常細胞生長信號。", m: "檢測方式：全身癌症指標" },
        { t: "綜合癌症與心血管風險", d: "同時評估癌症指標與心血管硬化風險，一次掌握兩大殺手。", m: "檢測方式：抽血檢測" },
        { t: "腦部與神經功能篩查", d: "針對神經衰退與早發型腦部功能退化進行評估。", m: "檢測方式：功能性評估" }
    ];

    const data = {
        male: { first: {30:8464, 45:10199, 60:14175}, renew: {30:8563, 45:10878, 60:16180, 75:23153} },
        female: { first: {30:8696, 45:10688, 60:12184}, renew: {30:8872, 45:11529, 60:13524, 75:15865} }
    };

    function setGender(g, btn) {
        gender = g;
        document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('cancerTitle').innerText = (g === 'male' ? '男性' : '女性') + '十大癌症分布';
        render();
    }

    function updateAge(type) {
        const i = document.getElementById('ageInput'), s = document.getElementById('ageSlider');
        if(type === 'input') s.value = i.value; else i.value = s.value;
        render();
    }

    function getRate(g, age, isFirst) {
        const set = isFirst ? data[g].first : data[g].renew;
        const keys = Object.keys(set).map(Number).sort((a,b)=>b-a);
        for(let k of keys) { if(age >= k) return set[k]; }
        return set[30];
    }

    function render() {
        const age = parseInt(document.getElementById('ageInput').value);
        document.getElementById('curAge').innerText = age;
        const f = getRate(gender, age, true);
        document.getElementById('firstYear').innerText = '$' + f.toLocaleString();
        document.getElementById('secondYear').innerText = '$' + getRate(gender, age+1, false).toLocaleString();
        document.getElementById('endAge').innerText = age + 30;

        let t10=0, t20=0, t30=0;
        for(let i=0; i<30; i++){
            let cur = age + i; if(cur > 75) break;
            let p = (i===0) ? f : getRate(gender, cur, false);
            if(i < 10) t10 += p; if(i < 20) t20 += p; if(i < 30) t30 += p;
        }
        document.getElementById('total10').innerText = '$' + t10.toLocaleString();
        document.getElementById('total20').innerText = '$' + t20.toLocaleString();
        document.getElementById('total30').innerText = '$' + t30.toLocaleString();
        updateCharts();
    }

    function updateCharts() {
        const cData = gender === 'male' ? [15, 14, 12, 10, 9, 8, 7, 6, 5, 14] : [25, 12, 11, 10, 8, 7, 6, 5, 4, 12];
        const cLabels = gender === 'male' ? ['大腸', '肺', '肝', '口腔', '攝護腺', '食道', '胃', '皮膚', '淋巴', '其他'] : ['乳癌', '大腸', '肺', '甲狀腺', '子宮', '肝', '卵巢', '皮膚', '胃', '其他'];
        cChart.data.labels = cLabels;
        cChart.data.datasets[0].data = cData;
        cChart.update();
    }

    function selectPlan(idx, el) {
        document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        const v = document.getElementById('detail-view');
        v.style.display = 'block';
        document.getElementById('pTitle').innerText = plans[idx].t;
        document.getElementById('pDesc').innerText = plans[idx].d;
        document.getElementById('pMethod').innerText = plans[idx].m;
    }

    window.onload = () => {
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }, // 關閉下方圖例，因為我們要直接在圖上寫字
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 10 },
                    formatter: (value, ctx) => ctx.chart.data.labels[ctx.dataIndex] + '\n' + value + '%',
                    align: 'center',
                    display: 'auto'
                }
            }
        };

        sChart = new Chart(document.getElementById('survivalChart'), {
            type: 'doughnut',
            data: { labels: ['早期發現', '晚期發現'], datasets: [{ data: [90, 20], backgroundColor: ['#28a745', '#dc3545'] }] },
            options: chartOptions
        });

        cChart = new Chart(document.getElementById('cancerChart'), {
            type: 'pie',
            data: { labels: [], datasets: [{ data: [], backgroundColor: ['#003f5c','#2f4b7c','#665191','#a05195','#d45087','#f95d6a','#ff7c43','#ffa600','#488f31','#de425b'] }] },
            options: chartOptions
        });
        render();
    };
</script>
</body>
</html>
